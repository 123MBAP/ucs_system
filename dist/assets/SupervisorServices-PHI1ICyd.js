import{j as t}from"./index-DZTFkylD.js";import{R as a}from"./react-CzDbI3ao.js";const o="http://localhost:4000";function K(){const[$,F]=a.useState([]),[b,I]=a.useState([]),[V,y]=a.useState(!1),[j,N]=a.useState(null),[d,L]=a.useState(String(new Date().getFullYear())),[c,R]=a.useState(String(new Date().getMonth()+1)),[m,O]=a.useState(""),[B,S]=a.useState(!1),[w,C]=a.useState(null),[k,D]=a.useState([]),[P,T]=a.useState(null),[M,u]=a.useState(!1),[_,f]=a.useState(""),[i,E]=a.useState(!1),[v,A]=a.useState(null),[n,U]=a.useState("complete"),[z,h]=a.useState(null);async function x(){try{y(!0),N(null);const e=localStorage.getItem("token");if(!e)throw new Error("Not authenticated");const s=await fetch(`${o}/api/supervisor/schedule`,{headers:{Authorization:`Bearer ${e}`},credentials:"include"});if(!s.ok)throw new Error("Failed to load schedule");const r=await s.json();I(Array.isArray(r==null?void 0:r.schedule)?r.schedule:[])}catch(e){N((e==null?void 0:e.message)||"Failed to load schedule")}finally{y(!1)}}async function p(){try{C(null),S(!0);const e=localStorage.getItem("token");if(!e)throw new Error("Not authenticated");const s=new URLSearchParams;m&&s.set("zone_id",m),d&&s.set("year",d),c&&s.set("month",c);const r=await fetch(`${o}/api/supervisor/completed-services?${s}`,{headers:{Authorization:`Bearer ${e}`},credentials:"include"});if(!r.ok)throw new Error("Failed to load completed services");const l=await r.json();D(Array.isArray(l==null?void 0:l.services)?l.services:[])}catch(e){C((e==null?void 0:e.message)||"Failed to load")}finally{S(!1)}}function Y(){x(),p()}a.useEffect(()=>{x()},[]),a.useEffect(()=>{p()},[d,c,m]),a.useEffect(()=>{let e=!0;return(async()=>{try{const s=localStorage.getItem("token");if(!s)throw new Error("Not authenticated");const r=await fetch(`${o}/api/supervisor/zones`,{headers:{Authorization:`Bearer ${s}`},credentials:"include"});if(!r.ok)throw new Error("Failed to load zones");const l=await r.json();if(!e)return;const q=((l==null?void 0:l.zones)||[]).map(g=>({id:g.id,name:g.zone_name||g.name}));F(q)}catch{}})(),()=>{e=!1}},[]);async function J(e){try{h(e);const s=localStorage.getItem("token");if(!s)throw new Error("Not authenticated");if(!(await fetch(`${o}/api/supervisor/service/${e}/verify`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},credentials:"include",body:JSON.stringify({status:"complete",reason:null})})).ok)throw new Error("Failed to confirm");await Promise.all([x(),p()])}catch(s){console.error(s)}finally{h(null)}}function Z(e){A(e),U("not_complete"),f(""),u(!0)}async function W(){if(v)try{E(!0),h(v);const e=localStorage.getItem("token");if(!e)throw new Error("Not authenticated");if(!(await fetch(`${o}/api/supervisor/service/${v}/verify`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},credentials:"include",body:JSON.stringify({status:n,reason:_.trim()||null})})).ok)throw new Error("Failed to submit verification");await Promise.all([x(),p()]),u(!1),A(null),f("")}catch(e){console.error(e)}finally{E(!1),h(null)}}return t.jsxs("div",{className:"space-y-6 lg:space-y-0 lg:grid lg:grid-cols-3 lg:gap-6",children:[t.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("h2",{className:"text-2xl font-bold text-slate-800",children:"Services Supervision"}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"text-sm text-slate-600",children:"Unconfirmed services across your zones"}),t.jsx("button",{onClick:Y,className:"inline-flex items-center rounded-md border border-slate-300 bg-white px-3 py-1.5 text-sm text-slate-700 hover:bg-slate-50",children:"Refresh"})]})]}),j&&t.jsx("div",{className:"text-sm text-red-600",children:j}),V?t.jsx("div",{className:"rounded-lg border border-slate-200 bg-white p-6 text-center text-slate-500",children:"Loading…"}):b.length===0?t.jsx("div",{className:"rounded-lg border border-slate-200 bg-white p-6 text-center text-slate-500",children:"No entries"}):t.jsx("div",{className:"space-y-4",children:b.map(e=>{var s,r;return t.jsxs("div",{className:"rounded-lg border border-slate-200 bg-white p-4",children:[t.jsxs("div",{className:"text-xs text-slate-500",children:["Created at: ",new Date(e.created_at).toLocaleString()]}),t.jsxs("div",{className:"mt-2 space-y-1 text-sm",children:[t.jsxs("div",{children:[t.jsx("span",{className:"font-medium",children:"Vehicle:"})," ",e.vehicle_plate??"—"]}),t.jsxs("div",{children:[t.jsx("span",{className:"font-medium",children:"Driver:"})," ",e.driver_username??"—"]})]}),t.jsxs("div",{className:"mt-3 space-y-1 text-sm",children:[t.jsxs("div",{children:["The service will start at: ",(s=e.service_start)==null?void 0:s.slice(0,5)]}),t.jsxs("div",{children:["The service will end at: ",(r=e.service_end)==null?void 0:r.slice(0,5)]})]}),e.chief_report_status?t.jsxs("div",{className:"mt-4 flex items-center gap-2",children:[t.jsx("button",{onClick:()=>J(e.id),disabled:z===e.id,className:"inline-flex items-center rounded-md bg-emerald-600 px-3 py-1.5 text-white text-sm hover:bg-emerald-700 disabled:opacity-60",children:"Confirm completion"}),t.jsx("button",{onClick:()=>Z(e.id),disabled:z===e.id,className:"inline-flex items-center rounded-md bg-red-600 px-3 py-1.5 text-white text-sm hover:bg-red-700 disabled:opacity-60",children:"Mark not completed"}),e.chief_report_reason?t.jsxs("span",{className:"ml-2 text-xs text-slate-500",children:["Chief note: ",e.chief_report_reason]}):null]}):t.jsx("div",{className:"mt-4 inline-flex items-center gap-2 rounded-md bg-slate-50 px-3 py-2 text-sm text-slate-700 border border-slate-200",children:"Waiting for chief report"})]},e.id)})})]}),t.jsx("div",{className:"lg:col-span-1",children:t.jsxs("div",{className:"rounded-lg border border-slate-200 bg-white p-4 lg:sticky lg:top-4",children:[t.jsx("div",{className:"flex items-center justify-between",children:t.jsx("h3",{className:"text-base font-semibold text-slate-800",children:"Confirmed services"})}),t.jsxs("div",{className:"mt-3 grid grid-cols-3 gap-2",children:[t.jsxs("select",{className:"w-full rounded-md border border-slate-300 bg-white px-2 py-1 text-sm",value:m,onChange:e=>O(e.target.value),children:[t.jsx("option",{value:"",children:"All zones"}),$.map(e=>t.jsx("option",{value:String(e.id),children:e.name},e.id))]}),t.jsxs("select",{className:"w-full rounded-md border border-slate-300 bg-white px-2 py-1 text-sm",value:d,onChange:e=>L(e.target.value),children:[t.jsx("option",{value:"",children:"All years"}),Array.from({length:7}).map((e,s)=>{const r=new Date().getFullYear()-s;return t.jsx("option",{value:String(r),children:r},r)})]}),t.jsxs("select",{className:"w-full rounded-md border border-slate-300 bg-white px-2 py-1 text-sm",value:c,onChange:e=>R(e.target.value),children:[t.jsx("option",{value:"",children:"All months"}),Array.from({length:12}).map((e,s)=>{const r=s+1;return t.jsx("option",{value:String(r),children:r.toString().padStart(2,"0")},r)})]})]}),w&&t.jsx("div",{className:"mt-2 text-xs text-red-600",children:w}),t.jsx("div",{className:"mt-3 space-y-2",children:B?t.jsx("div",{className:"text-sm text-slate-500",children:"Loading…"}):k.length===0?t.jsx("div",{className:"text-sm text-slate-500",children:"No confirmed services"}):k.map(e=>t.jsxs("div",{onClick:()=>T(s=>s===e.id?null:e.id),className:"cursor-pointer w-full text-left rounded-md border border-slate-200 px-3 py-2 hover:bg-slate-50",children:[t.jsxs("div",{className:"text-sm font-medium text-slate-800",children:[e.vehicle_plate??"—"," • ",e.driver_username??"—"]}),t.jsx("div",{className:"text-xs text-slate-500",children:new Date(e.supervisor_decided_at||e.created_at).toLocaleString()}),P===e.id&&t.jsxs("div",{className:"mt-2 text-xs text-slate-700 space-y-1",children:[t.jsxs("div",{children:["Start: ",String(e.service_start).slice(0,5)," • End: ",String(e.service_end).slice(0,5)]}),e.supervisor_reason?t.jsxs("div",{children:["Supervisor note: ",e.supervisor_reason]}):null]})]},e.id))})]})}),M&&t.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[t.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:()=>i?null:u(!1)}),t.jsxs("div",{className:"relative z-10 w-full max-w-md rounded-lg border border-slate-200 bg-white p-4 shadow-lg",children:[t.jsx("div",{className:"text-base font-semibold text-slate-800",children:n==="complete"?"Confirm completion":"Mark not completed"}),t.jsx("div",{className:"mt-2 text-sm text-slate-600",children:n==="complete"?"Optional note":"Provide a reason (optional)"}),t.jsx("textarea",{value:_,onChange:e=>f(e.target.value),className:"mt-3 h-28 w-full resize-none rounded-md border border-slate-300 p-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-300",placeholder:n==="complete"?"Note (optional)":"Reason (optional)",disabled:i}),t.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[t.jsx("button",{onClick:()=>i?null:u(!1),className:"inline-flex items-center rounded-md border border-slate-300 px-3 py-1.5 text-sm text-slate-700 hover:bg-slate-50",disabled:i,children:"Cancel"}),t.jsx("button",{onClick:W,className:`inline-flex items-center rounded-md px-3 py-1.5 text-white text-sm disabled:opacity-60 ${n==="complete"?"bg-emerald-600 hover:bg-emerald-700":"bg-red-600 hover:bg-red-700"}`,disabled:i,children:"Submit"})]})]})]})]})}export{K as default};
