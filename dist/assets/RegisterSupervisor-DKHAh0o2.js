import{j as e}from"./index-8yk-1D8L.js";import{r as t,u as U,L as q}from"./react-CzDbI3ao.js";const g="http://localhost:4000",O=()=>{const[w,y]=t.useState(""),[k,C]=t.useState(""),[u,p]=t.useState(""),[x,v]=t.useState([]),[L,F]=t.useState([]),[A,I]=t.useState([]),[f,Z]=t.useState(""),[j,i]=t.useState(!1),[$,b]=t.useState(null),[z,l]=t.useState(null),S=U(),N=new URLSearchParams(S.search),d=N.get("reassign")==="1",[m,E]=t.useState("existing");function B(s){v(r=>r.includes(s)?r.filter(a=>a!==s):[...r,s])}t.useEffect(()=>{const s=localStorage.getItem("token");s&&(fetch(`${g}/api/zones`,{headers:{Authorization:`Bearer ${s}`}}).then(async r=>{const a=await r.json();if(!r.ok)throw new Error((a==null?void 0:a.error)||"Failed to load zones");const n=(a.zones||[]).map(h=>({id:String(h.id),name:h.zone_name}));F(n);const c=new URLSearchParams(S.search).get("zoneId");c&&n.some(h=>h.id===String(c))&&v([String(c)])}).catch(r=>console.error("Load zones error:",r)),fetch(`${g}/api/manager/users?role=supervisor`,{headers:{Authorization:`Bearer ${s}`}}).then(async r=>{const a=await r.json();if(!r.ok)throw new Error((a==null?void 0:a.error)||"Failed to load supervisors");const n=(a.users||[]).map(o=>({id:String(o.id),username:o.username}));I(n)}).catch(r=>console.error("Load supervisors error:",r)))},[S.search]);function R(s){if(s.preventDefault(),l(null),b(null),i(!0),d&&m==="existing"){if(!x.length){l("Select a zone to assign."),i(!1);return}if(!f){l("Select a supervisor to assign."),i(!1);return}const a=localStorage.getItem("token");if(!a){l("You must be logged in as manager to reassign a supervisor."),i(!1);return}const n=x[0];fetch(`${g}/api/manager/zones/${n}/reassign-supervisor`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({supervisorUserId:Number(f)})}).then(async o=>{const c=await o.json();if(!o.ok)throw new Error((c==null?void 0:c.error)||"Failed to reassign supervisor");b("Supervisor reassigned successfully.")}).catch(o=>l((o==null?void 0:o.message)||"Failed to reassign supervisor")).finally(()=>i(!1));return}if(!w.trim()||!k.trim()||!u.trim()){l("First name, last name and username/email are required."),i(!1);return}const r=localStorage.getItem("token");if(!r){l("You must be logged in as manager to create a supervisor."),i(!1);return}fetch(`${g}/api/manager/supervisors`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({username:u})}).then(async a=>{const n=await a.json();if(!a.ok)throw new Error((n==null?void 0:n.error)||"Failed to create supervisor");b(`Supervisor created. Temporary password: ${n.tempPassword}`),y(""),C(""),p(""),v([])}).catch(a=>l(a.message||"Failed to create supervisor")).finally(()=>i(!1))}return e.jsxs("div",{className:"p-6 max-w-2xl",children:[d&&N.get("zoneId")&&e.jsx("div",{className:"mb-2",children:e.jsx(q,{to:`/zones/${N.get("zoneId")}`,className:"text-blue-600 underline text-sm",children:"← Back to Zone"})}),e.jsx("h2",{className:"text-2xl font-bold mb-4",children:d?"Reassign Supervisor":"Create the supervisor"}),e.jsxs("form",{onSubmit:R,className:"space-y-4",children:[z&&e.jsx("div",{className:"text-red-600",children:z}),$&&e.jsx("div",{className:"text-green-600",children:$}),!(d&&m==="existing")&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"First Name"}),e.jsx("input",{className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm",value:w,onChange:s=>y(s.target.value),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Last Name"}),e.jsx("input",{className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm",value:k,onChange:s=>C(s.target.value),required:!0})]})]}),!d&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Username or Email"}),e.jsx("input",{className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm",value:u,onChange:s=>p(s.target.value),required:!0})]}),d&&e.jsxs("div",{className:"p-4 border rounded-md",children:[e.jsxs("div",{className:"mb-3",children:[e.jsxs("label",{className:"inline-flex items-center",children:[e.jsx("input",{type:"radio",name:"mode",value:"existing",checked:m==="existing",onChange:()=>E("existing"),className:"mr-2"}),e.jsx("span",{children:"Assign to an existing supervisor"})]}),e.jsxs("label",{className:"inline-flex items-center ml-6",children:[e.jsx("input",{type:"radio",name:"mode",value:"new",checked:m==="new",onChange:()=>E("new"),className:"mr-2"}),e.jsx("span",{children:"Create a new supervisor"})]})]}),m==="existing"?e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Select Supervisor"}),e.jsxs("select",{value:f,onChange:s=>Z(s.target.value),className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm",children:[e.jsx("option",{value:"",children:"-- Select supervisor --"}),A.map(s=>e.jsx("option",{value:s.id,children:s.username},s.id))]})]}):e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Username or Email"}),e.jsx("input",{className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm",value:u,onChange:s=>p(s.target.value)})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Assign Zones (optional)"}),e.jsx("div",{className:"mt-2 space-y-2",children:L.map(s=>e.jsxs("label",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",checked:x.includes(s.id),onChange:()=>B(s.id)}),e.jsx("span",{children:s.name})]},s.id))})]}),e.jsx("div",{children:e.jsx("button",{type:"submit",disabled:j,className:`px-4 py-2 text-white rounded-md ${j?"bg-blue-400":"bg-blue-600 hover:bg-blue-700"}`,children:j?"Creating…":"Create Supervisor"})})]})]})};export{O as default};
