import{j as e}from"./index-B9Qtw13a.js";import{f as H,u as J,r as i,L as _}from"./react-BeLGUnOF.js";const u="http://localhost:4000",Q=()=>{const y=H(),E=J(),[o,z]=i.useState(null),[j,A]=i.useState([]),[N,I]=i.useState([]),[b,L]=i.useState({}),[c,F]=i.useState(null),[P,m]=i.useState(!1),[k,v]=i.useState(null),[x,B]=i.useState(""),[M,R]=i.useState([]),[p,Z]=i.useState(""),[d,w]=i.useState(new Set),[f,D]=i.useState(""),[C,g]=i.useState(null);i.useEffect(()=>{const t=localStorage.getItem("token");t&&fetch(`${u}/api/me`,{headers:{Authorization:`Bearer ${t}`}}).then(async a=>{var n;const s=await a.json();if(!a.ok)throw new Error((s==null?void 0:s.error)||"Failed to load user");z(((n=s==null?void 0:s.user)==null?void 0:n.role)??null)}).catch(()=>{})},[]),i.useEffect(()=>{const t=localStorage.getItem("token");!t||o!=="manager"||fetch(`${u}/api/report/supervisors`,{headers:{Authorization:`Bearer ${t}`}}).then(async a=>{const s=await a.json();if(!a.ok)throw new Error((s==null?void 0:s.error)||"Failed to load supervisors");R(Array.isArray(s.supervisors)?s.supervisors:[])}).catch(()=>{})},[o]),i.useEffect(()=>{const t=localStorage.getItem("token");if(!t)return;if(m(!0),v(null),o==="chief"){fetch(`${u}/api/chief/clients`,{headers:{Authorization:`Bearer ${t}`}}).then(async s=>{const n=await s.json();if(!s.ok)throw new Error((n==null?void 0:n.error)||"Failed to load clients");I(Array.isArray(n.clients)?n.clients:[])}).catch(s=>v((s==null?void 0:s.message)||"Failed to load")).finally(()=>m(!1));return}fetch(`${u}/api/zones${o==="supervisor"?"?scope=supervisor":""}`,{headers:{Authorization:`Bearer ${t}`}}).then(async s=>{const n=await s.json();if(!s.ok)throw new Error((n==null?void 0:n.error)||"Failed to load zones");let r=(n.zones||[]).map(l=>({id:l.id,zone_name:l.zone_name,cell:l.cell,village:l.village,chief_username:l.chief_username??null,client_count:Number(l.client_count||0)}));return o==="manager"&&p&&(r=(n.zones||[]).filter(l=>String(l.supervisor_id||"")===p).map(l=>({id:l.id,zone_name:l.zone_name,cell:l.cell,village:l.village,chief_username:l.chief_username??null,client_count:Number(l.client_count||0)}))),A(r),r}).then(async s=>{const n=localStorage.getItem("token");if(!n)return;const r={};for(const l of s)try{const h=await fetch(`${u}/api/clients/by-zone/${l.id}`,{headers:{Authorization:`Bearer ${n}`}}),$=await h.json();h.ok&&(r[l.id]=Array.isArray($.clients)?$.clients:[])}catch{}L(r)}).catch(s=>v((s==null?void 0:s.message)||"Failed to load")).finally(()=>m(!1))},[E.search,o,p]);const S=i.useMemo(()=>{const t=x.toLowerCase().trim();return t?N.filter(a=>{var s,n;return(a.username||"").toLowerCase().includes(t)||(a.phone_number||"").toLowerCase().includes(t)||`${((s=a.name)==null?void 0:s.first)||""} ${((n=a.name)==null?void 0:n.last)||""}`.trim().toLowerCase().includes(t)}):N},[N,x]),U=i.useMemo(()=>{const t=x.toLowerCase().trim();if(!t)return b;const a={};for(const[s,n]of Object.entries(b))a[Number(s)]=n.filter(r=>{var l,h;return(r.username||"").toLowerCase().includes(t)||(r.phone_number||"").toLowerCase().includes(t)||`${((l=r.name)==null?void 0:l.first)||""} ${((h=r.name)==null?void 0:h.last)||""}`.trim().toLowerCase().includes(t)});return a},[b,x]);function T(t){w(a=>{const s=new Set(a);return s.has(t)?s.delete(t):s.add(t),s})}async function q(){const t=localStorage.getItem("token");if(!(!t||!d.size)&&confirm(`Delete ${d.size} client(s)?`)){m(!0);try{await Promise.all(Array.from(d).map(async a=>{await fetch(`${u}/api/clients/${a}`,{method:"DELETE",headers:{Authorization:`Bearer ${t}`}})})),w(new Set),y(0)}finally{m(!1)}}}async function O(){const t=localStorage.getItem("token"),a=Number(f);if(!(!t||!d.size||!Number.isFinite(a))){m(!0);try{await Promise.all(Array.from(d).map(async s=>{await fetch(`${u}/api/clients/${s}/zone`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({zoneId:a})})})),w(new Set),y(0)}finally{m(!1)}}}return e.jsxs("div",{className:"p-6 min-h-screen",style:{backgroundColor:"#F9FAFB"},children:[e.jsx("div",{className:"mb-2",children:e.jsx("button",{onClick:()=>y(-1),className:"text-amber-600 underline text-sm",children:"← Back"})}),e.jsx("h2",{className:"text-2xl font-bold mb-4",style:{color:"#1E1E1E"},children:"Clients"}),e.jsxs("div",{className:"mb-4 flex flex-wrap items-end gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm",style:{color:"#1E1E1E"},children:"Search"}),e.jsx("input",{value:x,onChange:t=>B(t.target.value),className:"mt-1 border rounded px-3 py-2 focus:outline-none focus:ring-2",style:{borderColor:"#E2E8F0"},placeholder:"Search by name, username or phone"})]}),o==="manager"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm",style:{color:"#1E1E1E"},children:"Supervisor"}),e.jsxs("select",{className:"mt-1 border rounded px-2 py-2 focus:outline-none focus:ring-2",style:{borderColor:"#E2E8F0"},value:p,onChange:t=>Z(t.target.value),children:[e.jsx("option",{value:"",children:"All Supervisors"}),M.map(t=>e.jsx("option",{value:t.id,children:t.username},t.id))]})]})]}),k&&e.jsx("div",{className:"text-red-600 mb-3",children:k}),P?e.jsx("div",{children:"Loading…"}):e.jsxs(e.Fragment,{children:[o==="chief"?e.jsx("div",{className:"overflow-x-auto bg-white border rounded shadow",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Photo"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Name"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Username"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Phone"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Amount"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsxs("tbody",{className:"bg-white divide-y divide-gray-200",children:[S.map(t=>{const a=t.name?`${t.name.first||""} ${t.name.last||""}`.trim():"";return e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2",children:t.profile_image_url?e.jsx("button",{onClick:()=>g(t.profile_image_url),className:"block",children:e.jsx("img",{src:t.profile_image_url,alt:"",className:"w-10 h-10 rounded-full object-cover cursor-zoom-in"})}):e.jsx("div",{className:"w-8 h-8 rounded-full bg-gray-200"})}),e.jsx("td",{className:"px-3 py-2",children:a||t.username}),e.jsx("td",{className:"px-3 py-2",children:t.username}),e.jsx("td",{className:"px-3 py-2",children:t.phone_number}),e.jsx("td",{className:"px-3 py-2",children:t.monthly_amount!=null?Number(t.monthly_amount).toLocaleString():"-"}),e.jsx("td",{className:"px-3 py-2",children:e.jsx(_,{to:`/payments?scope=chief&clientId=${encodeURIComponent(String(t.id))}&clientName=${encodeURIComponent((t.name?`${t.name.first||""} ${t.name.last||""}`.trim():"")||t.username)}`,className:"px-2 py-1 text-sm rounded",style:{backgroundColor:"#D97706",color:"#1E1E1E"},children:"Pay"})})]},t.id)}),!S.length&&e.jsx("tr",{children:e.jsx("td",{className:"px-3 py-4 text-gray-600",colSpan:5,children:"No clients."})})]})]})}):e.jsxs("div",{className:"overflow-x-auto bg-white border rounded shadow",children:[e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-10",children:"Sel"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Photo"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Name"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Username"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Phone"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Amount"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Zone"})]})}),e.jsxs("tbody",{className:"bg-white divide-y divide-gray-200",children:[j.flatMap(t=>{const a=U[t.id]||[],s=e.jsx("tr",{className:"bg-gray-50",children:e.jsx("td",{className:"px-3 py-2 text-gray-600",colSpan:6,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"font-semibold",children:[t.zone_name," ",e.jsxs("span",{className:"text-xs text-gray-500",children:["(#",t.id,")"]})]}),e.jsxs("div",{className:"text-sm text-gray-600",children:["Clients: ",a.length]})]})})},`zone-${t.id}`),n=a.map(r=>{const l=r.name?`${r.name.first||""} ${r.name.last||""}`.trim():"";return e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2",children:e.jsx("input",{type:"checkbox",checked:d.has(r.id),onChange:()=>T(r.id)})}),e.jsx("td",{className:"px-3 py-2",children:r.profile_image_url?e.jsx("button",{onClick:()=>g(r.profile_image_url),className:"block",children:e.jsx("img",{src:r.profile_image_url,alt:"",className:"w-10 h-10 rounded-full object-cover cursor-zoom-in"})}):e.jsx("div",{className:"w-8 h-8 rounded-full bg-gray-200"})}),e.jsx("td",{className:"px-3 py-2",children:l||r.username}),e.jsx("td",{className:"px-3 py-2",children:r.username}),e.jsx("td",{className:"px-3 py-2",children:r.phone_number}),e.jsx("td",{className:"px-3 py-2",children:r.monthly_amount!=null?Number(r.monthly_amount).toLocaleString():"-"}),e.jsx("td",{className:"px-3 py-2",children:t.zone_name})]},r.id)});return[s,...n]}),!j.length&&e.jsx("tr",{children:e.jsx("td",{className:"px-3 py-4 text-gray-600",colSpan:6,children:"No zones."})})]})]}),(o==="manager"||o==="supervisor")&&e.jsxs("div",{className:"p-3 border-t flex items-center gap-3",children:[e.jsx("button",{disabled:!d.size,onClick:q,className:`px-3 py-2 rounded text-white ${d.size?"bg-red-600":"bg-gray-300 cursor-not-allowed"}`,children:"Delete Selected"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{className:"border rounded px-2 py-2 focus:outline-none focus:ring-2",style:{borderColor:"#E2E8F0"},value:f,onChange:t=>D(t.target.value),children:[e.jsx("option",{value:"",children:"Move to zone…"}),j.map(t=>e.jsx("option",{value:t.id,children:t.zone_name},t.id))]}),e.jsx("button",{disabled:!d.size||!f,onClick:O,className:`px-3 py-2 rounded text-white ${d.size&&f?"bg-amber-600":"bg-gray-300 cursor-not-allowed"}`,children:"Move Selected"})]})]})]}),c&&o==="chief"&&e.jsxs("div",{className:"mt-4 bg-white border rounded shadow p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Make Payment"}),e.jsxs("p",{className:"text-sm text-gray-600 mt-1",children:["For client: ",e.jsx("span",{className:"font-medium",children:(c.name?`${c.name.first||""} ${c.name.last||""}`.trim():"")||c.username})]})]}),e.jsx("button",{onClick:()=>F(null),className:"text-sm text-gray-600 hover:text-gray-800",children:"Clear"})]}),e.jsx("div",{className:"mt-3",children:e.jsx(_,{to:`/payments?scope=chief&clientId=${encodeURIComponent(String(c.id))}&clientName=${encodeURIComponent((c.name?`${c.name.first||""} ${c.name.last||""}`.trim():"")||c.username)}`,className:"inline-flex items-center px-4 py-2 rounded font-semibold",style:{backgroundColor:"#D97706",color:"#1E1E1E"},children:"Proceed to Payment"})})]}),C&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/60",onClick:()=>g(null)}),e.jsxs("div",{className:"relative z-10 max-w-3xl w-full",children:[e.jsx("img",{src:C,alt:"Client",className:"max-h-[80vh] w-full object-contain rounded-lg shadow-2xl bg-white"}),e.jsx("div",{className:"absolute top-2 right-2",children:e.jsx("button",{onClick:()=>g(null),className:"px-3 py-1 rounded-md text-white bg-black/60 hover:bg-black/80 text-sm",children:"Close"})})]})]})]})]})};export{Q as default};
