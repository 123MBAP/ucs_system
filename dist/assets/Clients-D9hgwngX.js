import{u as W,j as e}from"./index-B34CxXhK.js";import{f as X,u as Y,r as o,L as F}from"./react-BeLGUnOF.js";const p="http://localhost:4000",se=()=>{const{t:n,lang:P,setLang:T}=W(),v=X(),B=Y(),[d,Z]=o.useState(null),[j,R]=o.useState([]),[w,M]=o.useState([]),[k,D]=o.useState({}),[m,q]=o.useState(null),[U,x]=o.useState(!1),[$,C]=o.useState(null),[g,O]=o.useState(""),[H,J]=o.useState([]),[b,G]=o.useState(""),[c,S]=o.useState(new Set),[h,E]=o.useState(""),[_,N]=o.useState(null),[z,K]=o.useState(null);o.useEffect(()=>{const t=localStorage.getItem("token");t&&fetch(`${p}/api/me`,{headers:{Authorization:`Bearer ${t}`}}).then(async l=>{var r;const s=await l.json();if(!l.ok)throw new Error((s==null?void 0:s.error)||"Failed to load user");Z(((r=s==null?void 0:s.user)==null?void 0:r.role)??null)}).catch(()=>{})},[]),o.useEffect(()=>{const t=localStorage.getItem("token");!t||d!=="manager"||fetch(`${p}/api/report/supervisors`,{headers:{Authorization:`Bearer ${t}`}}).then(async l=>{const s=await l.json();if(!l.ok)throw new Error((s==null?void 0:s.error)||"Failed to load supervisors");J(Array.isArray(s.supervisors)?s.supervisors:[])}).catch(()=>{})},[d]),o.useEffect(()=>{const t=localStorage.getItem("token");if(!t)return;if(x(!0),C(null),d==="chief"){fetch(`${p}/api/chief/clients`,{headers:{Authorization:`Bearer ${t}`}}).then(async s=>{const r=await s.json();if(!s.ok)throw new Error((r==null?void 0:r.error)||"Failed to load clients");M(Array.isArray(r.clients)?r.clients:[])}).catch(s=>C((s==null?void 0:s.message)||"Failed to load")).finally(()=>x(!1));return}fetch(`${p}/api/zones${d==="supervisor"?"?scope=supervisor":""}`,{headers:{Authorization:`Bearer ${t}`}}).then(async s=>{const r=await s.json();if(!s.ok)throw new Error((r==null?void 0:r.error)||"Failed to load zones");let a=(r.zones||[]).map(i=>({id:i.id,zone_name:i.zone_name,cell:i.cell,village:i.village,chief_username:i.chief_username??null,client_count:Number(i.client_count||0)}));return d==="manager"&&b&&(a=(r.zones||[]).filter(i=>String(i.supervisor_id||"")===b).map(i=>({id:i.id,zone_name:i.zone_name,cell:i.cell,village:i.village,chief_username:i.chief_username??null,client_count:Number(i.client_count||0)}))),R(a),a}).then(async s=>{const r=localStorage.getItem("token");if(!r)return;const a={};for(const i of s)try{const u=await fetch(`${p}/api/clients/by-zone/${i.id}`,{headers:{Authorization:`Bearer ${r}`}}),f=await u.json();u.ok&&(a[i.id]=Array.isArray(f.clients)?f.clients:[])}catch{}D(a)}).catch(s=>C((s==null?void 0:s.message)||"Failed to load")).finally(()=>x(!1))},[B.search,d,b]);const I=o.useMemo(()=>{const t=g.toLowerCase().trim();return t?w.filter(l=>{var s,r;return(l.username||"").toLowerCase().includes(t)||(l.phone_number||"").toLowerCase().includes(t)||`${((s=l.name)==null?void 0:s.first)||""} ${((r=l.name)==null?void 0:r.last)||""}`.trim().toLowerCase().includes(t)}):w},[w,g]),Q=o.useMemo(()=>{const t=g.toLowerCase().trim();if(!t)return k;const l={};for(const[s,r]of Object.entries(k))l[Number(s)]=r.filter(a=>{var i,u;return(a.username||"").toLowerCase().includes(t)||(a.phone_number||"").toLowerCase().includes(t)||`${((i=a.name)==null?void 0:i.first)||""} ${((u=a.name)==null?void 0:u.last)||""}`.trim().toLowerCase().includes(t)});return l},[k,g]);function V(t){S(l=>{const s=new Set(l);return s.has(t)?s.delete(t):s.add(t),s}),K(t)}async function A(){const t=localStorage.getItem("token");if(!(!t||!c.size)&&confirm(`Delete ${c.size} client(s)?`)){x(!0);try{await Promise.all(Array.from(c).map(async l=>{await fetch(`${p}/api/clients/${l}`,{method:"DELETE",headers:{Authorization:`Bearer ${t}`}})})),S(new Set),v(0)}finally{x(!1)}}}async function L(){const t=localStorage.getItem("token"),l=Number(h);if(!(!t||!c.size||!Number.isFinite(l))){x(!0);try{await Promise.all(Array.from(c).map(async s=>{await fetch(`${p}/api/clients/${s}/zone`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({zoneId:l})})})),S(new Set),v(0)}finally{x(!1)}}}return e.jsxs("div",{className:"p-6 min-h-screen",style:{backgroundColor:"#F9FAFB"},children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between gap-3",children:[e.jsxs("button",{onClick:()=>v(-1),className:"text-amber-600 underline text-sm",children:["â† ",n("clients.back")]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-sm",style:{color:"#1E1E1E"},children:n("common.language")}),e.jsxs("select",{value:P,onChange:t=>T(t.target.value),className:"border rounded px-2 py-1 text-sm",style:{borderColor:"#E2E8F0"},children:[e.jsx("option",{value:"en",children:n("lang.english")}),e.jsx("option",{value:"rw",children:n("lang.kinyarwanda")})]})]})]}),e.jsx("h2",{className:"text-2xl font-bold mb-4",style:{color:"#1E1E1E"},children:n("clients.title")}),e.jsxs("div",{className:"mb-4 flex flex-wrap items-end gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm",style:{color:"#1E1E1E"},children:n("clients.search.label")}),e.jsx("input",{value:g,onChange:t=>O(t.target.value),className:"mt-1 border rounded px-3 py-2 focus:outline-none focus:ring-2",style:{borderColor:"#E2E8F0"},placeholder:n("clients.search.placeholder")})]}),d==="manager"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm",style:{color:"#1E1E1E"},children:n("clients.manager.supervisor")}),e.jsxs("select",{className:"mt-1 border rounded px-2 py-2 focus:outline-none focus:ring-2",style:{borderColor:"#E2E8F0"},value:b,onChange:t=>G(t.target.value),children:[e.jsx("option",{value:"",children:n("clients.allSupervisors")}),H.map(t=>e.jsx("option",{value:t.id,children:t.username},t.id))]})]})]}),$&&e.jsx("div",{className:"text-red-600 mb-3",children:$}),U?e.jsx("div",{children:n("clients.loading")}):e.jsxs(e.Fragment,{children:[d==="chief"?e.jsx("div",{className:"overflow-x-auto bg-white border rounded shadow",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:n("clients.table.photo")}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:n("clients.table.name")}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:n("clients.table.username")}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:n("clients.table.phone")}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:n("clients.table.amountToPay")}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:n("clients.table.actions")})]})}),e.jsxs("tbody",{className:"bg-white divide-y divide-gray-200",children:[I.map(t=>{const l=t.name?`${t.name.first||""} ${t.name.last||""}`.trim():"";return e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2",children:t.profile_image_url?e.jsx("button",{onClick:()=>N(t.profile_image_url),className:"block",children:e.jsx("img",{src:t.profile_image_url,alt:"",className:"w-10 h-10 rounded-full object-cover cursor-zoom-in"})}):e.jsx("div",{className:"w-8 h-8 rounded-full bg-gray-200"})}),e.jsx("td",{className:"px-3 py-2",children:l||t.username}),e.jsx("td",{className:"px-3 py-2",children:t.username}),e.jsx("td",{className:"px-3 py-2",children:t.phone_number}),e.jsx("td",{className:"px-3 py-2",children:t.monthly_amount!=null?Number(t.monthly_amount).toLocaleString():"-"}),e.jsx("td",{className:"px-3 py-2",children:e.jsx(F,{to:`/payments?scope=chief&clientId=${encodeURIComponent(String(t.id))}&clientName=${encodeURIComponent((t.name?`${t.name.first||""} ${t.name.last||""}`.trim():"")||t.username)}`,className:"px-2 py-1 text-sm rounded",style:{backgroundColor:"#D97706",color:"#1E1E1E"},children:n("clients.pay")})})]},t.id)}),!I.length&&e.jsx("tr",{children:e.jsx("td",{className:"px-3 py-4 text-gray-600",colSpan:5,children:n("clients.noClients")})})]})]})}):e.jsxs("div",{className:"overflow-x-auto bg-white border rounded shadow",children:[e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-10",children:n("clients.table.sel")}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:n("clients.table.photo")}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:n("clients.table.name")}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:n("clients.table.username")}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:n("clients.table.phone")}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:n("clients.table.amountToPay")}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:n("clients.table.zone")})]})}),e.jsxs("tbody",{className:"bg-white divide-y divide-gray-200",children:[j.flatMap(t=>{const l=Q[t.id]||[],s=e.jsx("tr",{className:"bg-gray-50",children:e.jsx("td",{className:"px-3 py-2 text-gray-600",colSpan:6,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"font-semibold",children:[t.zone_name," ",e.jsxs("span",{className:"text-xs text-gray-500",children:["(#",t.id,")"]})]}),e.jsx("div",{className:"text-sm text-gray-600",children:n("clients.zones.header",{count:l.length})})]})})},`zone-${t.id}`),r=l.flatMap(a=>{const i=a.name?`${a.name.first||""} ${a.name.last||""}`.trim():"",u=e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2",children:e.jsx("input",{type:"checkbox",checked:c.has(a.id),onChange:()=>V(a.id)})}),e.jsx("td",{className:"px-3 py-2",children:a.profile_image_url?e.jsx("button",{onClick:()=>N(a.profile_image_url),className:"block",children:e.jsx("img",{src:a.profile_image_url,alt:"",className:"w-10 h-10 rounded-full object-cover cursor-zoom-in"})}):e.jsx("div",{className:"w-8 h-8 rounded-full bg-gray-200"})}),e.jsx("td",{className:"px-3 py-2",children:i||a.username}),e.jsx("td",{className:"px-3 py-2",children:a.username}),e.jsx("td",{className:"px-3 py-2",children:a.phone_number}),e.jsx("td",{className:"px-3 py-2",children:a.monthly_amount!=null?Number(a.monthly_amount).toLocaleString():"-"}),e.jsx("td",{className:"px-3 py-2",children:t.zone_name})]},a.id),f=z===a.id&&c.size>0?e.jsx("tr",{className:"bg-gray-50",children:e.jsx("td",{className:"px-3 py-2",colSpan:7,children:e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsx("button",{disabled:!c.size,onClick:A,className:`px-3 py-2 rounded text-white ${c.size?"bg-red-600":"bg-gray-300 cursor-not-allowed"}`,children:n("clients.deleteSelected")}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{className:"border rounded px-2 py-2 focus:outline-none focus:ring-2",style:{borderColor:"#E2E8F0"},value:h,onChange:y=>E(y.target.value),children:[e.jsx("option",{value:"",children:n("clients.moveToZone")}),j.map(y=>e.jsx("option",{value:y.id,children:y.zone_name},y.id))]}),e.jsx("button",{disabled:!c.size||!h,onClick:L,className:`px-3 py-2 rounded text-white ${c.size&&h?"bg-amber-600":"bg-gray-300 cursor-not-allowed"}`,children:n("clients.moveSelected")})]})]})})},`actions-${a.id}`):null;return f?[u,f]:[u]});return[s,...r]}),!j.length&&e.jsx("tr",{children:e.jsx("td",{className:"px-3 py-4 text-gray-600",colSpan:6,children:n("clients.noZones")})})]})]}),(d==="manager"||d==="supervisor")&&!(c.size>0&&z!==null)&&e.jsxs("div",{className:"p-3 border-t flex items-center gap-3",children:[e.jsx("button",{disabled:!c.size,onClick:A,className:`px-3 py-2 rounded text-white ${c.size?"bg-red-600":"bg-gray-300 cursor-not-allowed"}`,children:n("clients.deleteSelected")}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{className:"border rounded px-2 py-2 focus:outline-none focus:ring-2",style:{borderColor:"#E2E8F0"},value:h,onChange:t=>E(t.target.value),children:[e.jsx("option",{value:"",children:n("clients.moveToZone")}),j.map(t=>e.jsx("option",{value:t.id,children:t.zone_name},t.id))]}),e.jsx("button",{disabled:!c.size||!h,onClick:L,className:`px-3 py-2 rounded text-white ${c.size&&h?"bg-amber-600":"bg-gray-300 cursor-not-allowed"}`,children:n("clients.moveSelected")})]})]})]}),m&&d==="chief"&&e.jsxs("div",{className:"mt-4 bg-white border rounded shadow p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold",children:n("clients.makePayment")}),e.jsxs("p",{className:"text-sm text-gray-600 mt-1",children:[n("clients.forClient")," ",e.jsx("span",{className:"font-medium",children:(m.name?`${m.name.first||""} ${m.name.last||""}`.trim():"")||m.username})]})]}),e.jsx("button",{onClick:()=>q(null),className:"text-sm text-gray-600 hover:text-gray-800",children:n("clients.clear")})]}),e.jsx("div",{className:"mt-3",children:e.jsx(F,{to:`/payments?scope=chief&clientId=${encodeURIComponent(String(m.id))}&clientName=${encodeURIComponent((m.name?`${m.name.first||""} ${m.name.last||""}`.trim():"")||m.username)}`,className:"inline-flex items-center px-4 py-2 rounded font-semibold",style:{backgroundColor:"#D97706",color:"#1E1E1E"},children:n("clients.proceedToPayment")})})]}),_&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/60",onClick:()=>N(null)}),e.jsxs("div",{className:"relative z-10 max-w-3xl w-full",children:[e.jsx("img",{src:_,alt:"Client",className:"max-h-[80vh] w-full object-contain rounded-lg shadow-2xl bg-white"}),e.jsx("div",{className:"absolute top-2 right-2",children:e.jsx("button",{onClick:()=>N(null),className:"px-3 py-1 rounded-md text-white bg-black/60 hover:bg-black/80 text-sm",children:n("clients.close")})})]})]})]})]})};export{se as default};
