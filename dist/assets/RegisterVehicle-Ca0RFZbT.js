import{j as e}from"./index-8yk-1D8L.js";import{f as L,r as t}from"./react-CzDbI3ao.js";const o="http://localhost:4000",R=()=>{const I=L(),[h,f]=t.useState(""),[b,N]=t.useState(""),[w,y]=t.useState(""),[c,S]=t.useState(!1),[d,u]=t.useState("existing"),[O,z]=t.useState([]),[x,k]=t.useState(""),[g,C]=t.useState(""),[v,D]=t.useState(""),[p,$]=t.useState(!1),[E,m]=t.useState(null),[A,F]=t.useState(null);t.useEffect(()=>{const s=localStorage.getItem("token");s&&fetch(`${o}/api/manager/users?role=driver`,{headers:{Authorization:`Bearer ${s}`}}).then(async i=>{const r=await i.json();if(!i.ok)throw new Error((r==null?void 0:r.error)||"Failed to load drivers");z((r.users||[]).map(n=>({id:String(n.id),username:n.username})))}).catch(()=>{})},[]);function J(s){if(s.preventDefault(),m(null),F(null),!h.trim()){m("Plate is required");return}const i=localStorage.getItem("token");if(!i){m("You must be logged in as manager to register vehicles.");return}$(!0),fetch(`${o}/api/manager/vehicles`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({plate:h.trim(),make:b||void 0,model:w||void 0})}).then(async r=>{var P;const n=await r.json();if(!r.ok)throw new Error((n==null?void 0:n.error)||"Failed to register vehicle");const M=n.vehicle.id;if(c)if(d==="existing"){if(!x)throw new Error("Please select a driver to assign");const l=await fetch(`${o}/api/manager/drivers/${x}/vehicle`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({vehicleId:M})}),a=await l.json();if(!l.ok)throw new Error((a==null?void 0:a.error)||"Failed to assign vehicle to driver")}else{if(!g.trim()||!v.trim())throw new Error("Driver first and last name are required");const l=await fetch(`${o}/api/manager/drivers`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({firstName:g.trim(),lastName:v.trim()})}),a=await l.json();if(!l.ok)throw new Error((a==null?void 0:a.error)||"Failed to create driver");const T=(P=a==null?void 0:a.driver)==null?void 0:P.id;if(!T)throw new Error("Driver created but id missing");const B=await fetch(`${o}/api/manager/drivers/${T}/vehicle`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({vehicleId:M})}),j=await B.json();if(!B.ok)throw new Error((j==null?void 0:j.error)||"Failed to assign vehicle to new driver")}F(`Vehicle ${n.vehicle.plate} created${c?" and assigned":""}.`),f(""),N(""),y(""),S(!1),u("existing"),k(""),C(""),D("")}).catch(r=>m((r==null?void 0:r.message)||"Failed to register vehicle")).finally(()=>$(!1))}return e.jsxs("div",{className:"p-6 max-w-xl",children:[e.jsx("div",{className:"mb-2",children:e.jsx("button",{onClick:()=>I(-1),className:"text-blue-600 underline text-sm",children:"← Back"})}),e.jsx("h2",{className:"text-2xl font-bold mb-4",children:"Register Vehicle"}),E&&e.jsx("div",{className:"text-red-600 mb-2",children:E}),A&&e.jsx("div",{className:"text-green-600 mb-2",children:A}),e.jsxs("form",{onSubmit:J,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700",children:"Plate"}),e.jsx("input",{className:"mt-1 w-full border rounded px-3 py-2",value:h,onChange:s=>f(s.target.value),required:!0})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700",children:"Make"}),e.jsx("input",{className:"mt-1 w-full border rounded px-3 py-2",value:b,onChange:s=>N(s.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700",children:"Model"}),e.jsx("input",{className:"mt-1 w-full border rounded px-3 py-2",value:w,onChange:s=>y(s.target.value)})]})]}),e.jsx("div",{className:"pt-2",children:e.jsxs("label",{className:"inline-flex items-center",children:[e.jsx("input",{type:"checkbox",className:"mr-2",checked:c,onChange:s=>S(s.target.checked)}),e.jsx("span",{children:"Assign Driver (optional)"})]})}),c&&e.jsxs("div",{className:"p-4 border rounded",children:[e.jsxs("div",{className:"space-x-4 mb-3",children:[e.jsxs("label",{className:"inline-flex items-center",children:[e.jsx("input",{type:"radio",name:"assignMode",value:"existing",checked:d==="existing",onChange:()=>u("existing"),className:"mr-2"}),e.jsx("span",{children:"Assign to existing driver"})]}),e.jsxs("label",{className:"inline-flex items-center ml-4",children:[e.jsx("input",{type:"radio",name:"assignMode",value:"new",checked:d==="new",onChange:()=>u("new"),className:"mr-2"}),e.jsx("span",{children:"Create new driver"})]})]}),d==="existing"?e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700",children:"Select Driver"}),e.jsxs("select",{value:x,onChange:s=>k(s.target.value),className:"mt-1 w-full border rounded px-2 py-2",children:[e.jsx("option",{value:"",children:"-- Select driver --"}),O.map(s=>e.jsx("option",{value:s.id,children:s.username},s.id))]})]}):e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700",children:"Driver First Name"}),e.jsx("input",{className:"mt-1 w-full border rounded px-3 py-2",value:g,onChange:s=>C(s.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700",children:"Driver Last Name"}),e.jsx("input",{className:"mt-1 w-full border rounded px-3 py-2",value:v,onChange:s=>D(s.target.value)})]})]})]}),e.jsx("button",{type:"submit",disabled:p,className:`px-4 py-2 text-white rounded ${p?"bg-blue-400":"bg-blue-600 hover:bg-blue-700"}`,children:p?"Saving…":"Save Vehicle"})]})]})};export{R as default};
