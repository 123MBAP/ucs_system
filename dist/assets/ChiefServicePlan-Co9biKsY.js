import{j as e}from"./index-BdDvBGrt.js";import{R as l}from"./react-BeLGUnOF.js";const o="http://localhost:4000";function q(){const[i,b]=l.useState(null),[j,N]=l.useState(""),[y,h]=l.useState([]),[L,c]=l.useState(!1),[w,m]=l.useState(null),[x,D]=l.useState(new Date().getFullYear()),[p,B]=l.useState(new Date().getMonth()+1),[T,S]=l.useState(!1),[_,k]=l.useState(null),[C,P]=l.useState([]),[Z,O]=l.useState(null),[M,u]=l.useState(!1),[E,f]=l.useState(""),[d,R]=l.useState(!1),[$,z]=l.useState(null),[A,I]=l.useState(null);l.useEffect(()=>{let t=!0;return(async()=>{try{m(null);const s=localStorage.getItem("token");if(!s)throw new Error("Not authenticated");const a=await fetch(`${o}/api/chief/dashboard`,{headers:{Authorization:`Bearer ${s}`},credentials:"include"});if(!a.ok)throw new Error("Failed to load zone");const r=await a.json(),n=((r==null?void 0:r.zones)||[]).map(g=>({id:g.id,name:g.name}));if(!t)return;n.length?(b(n[0].id),N(n[0].name)):(b(null),N(""))}catch(s){if(!t)return;m((s==null?void 0:s.message)||"Failed to load")}})(),()=>{t=!1}},[]),l.useEffect(()=>{let t=!0;return(async()=>{if(!i){h([]);return}try{c(!0),m(null);const s=localStorage.getItem("token");if(!s)throw new Error("Not authenticated");const a=await fetch(`${o}/api/chief/zones/${i}/service-plan`,{headers:{Authorization:`Bearer ${s}`}});if(!a.ok)throw new Error("Failed to load schedule");const r=await a.json();if(!t)return;h((r==null?void 0:r.schedule)||[])}catch(s){if(!t)return;m((s==null?void 0:s.message)||"Failed to load schedule")}finally{t&&c(!1)}})(),()=>{t=!1}},[i]),l.useEffect(()=>{let t=!0;return(async()=>{try{k(null),S(!0);const s=localStorage.getItem("token");if(!s)throw new Error("Not authenticated");const a=new URLSearchParams({year:String(x),month:String(p)}),r=await fetch(`${o}/api/chief/completed-services?${a}`,{headers:{Authorization:`Bearer ${s}`},credentials:"include"});if(!r.ok)throw new Error("Failed to load completed services");const n=await r.json();if(!t)return;P(Array.isArray(n==null?void 0:n.services)?n.services:[])}catch(s){if(!t)return;k((s==null?void 0:s.message)||"Failed to load")}finally{t&&S(!1)}})(),()=>{t=!1}},[x,p]);async function F(t,s,a){try{I(t);const r=localStorage.getItem("token");if(!r)throw new Error("Not authenticated");if(!(await fetch(`${o}/api/chief/service/${t}/report`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},credentials:"include",body:JSON.stringify({status:s,reason:a??null})})).ok)throw new Error("Failed to submit report");if(i){c(!0);try{const v=await(await fetch(`${o}/api/chief/zones/${i}/service-plan`,{headers:{Authorization:`Bearer ${r}`}})).json();h((v==null?void 0:v.schedule)||[])}finally{c(!1)}}}catch(r){console.error(r)}finally{I(null)}}function Y(t){z(t),f(""),u(!0)}async function J(){if($)try{R(!0),await F($,"not_complete",E.trim()||null),u(!1),f(""),z(null)}finally{R(!1)}}return e.jsxs("div",{className:"space-y-6 lg:space-y-0 lg:grid lg:grid-cols-3 lg:gap-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-2xl font-bold text-slate-800",children:"Day of Service Plan"}),j&&e.jsxs("div",{className:"text-sm text-slate-600",children:["Zone: ",e.jsx("span",{className:"font-medium text-slate-800",children:j})]})]}),w&&e.jsx("div",{className:"text-red-600 text-sm",children:w}),e.jsx("div",{className:"lg:col-span-2 space-y-4",children:L?e.jsx("div",{className:"rounded-lg border border-slate-200 bg-white p-6 text-center text-slate-500",children:"Loading…"}):y.length===0?e.jsx("div",{className:"rounded-lg border border-slate-200 bg-white p-6 text-center text-slate-500",children:"No entries"}):e.jsx("div",{className:"space-y-4",children:y.filter(t=>!t.supervisor_status).map(t=>{var s,a;return e.jsxs("div",{className:"rounded-lg border border-slate-200 bg-white p-4",children:[e.jsxs("div",{className:"text-xs text-slate-500",children:["Created at: ",new Date(t.created_at).toLocaleString()]}),e.jsxs("div",{className:"mt-2 space-y-1 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Vehicle:"})," ",t.vehicle_plate??"—"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Driver:"})," ",t.driver_username??"—"]})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"font-medium text-sm",children:"Assigned Manpowers"}),Array.isArray(t.assigned_manpower_users)&&t.assigned_manpower_users.length?e.jsx("ul",{className:"mt-1 list-disc pl-5 text-sm text-slate-700",children:t.assigned_manpower_users.map(r=>e.jsx("li",{children:r.username},r.id))}):e.jsx("div",{className:"mt-1 text-sm text-slate-500",children:"—"})]}),e.jsxs("div",{className:"mt-3 space-y-1 text-sm",children:[e.jsxs("div",{children:["The service will start at: ",(s=t.service_start)==null?void 0:s.slice(0,5)]}),e.jsxs("div",{children:["The service will end at: ",(a=t.service_end)==null?void 0:a.slice(0,5)]})]}),t.chief_report_status?e.jsxs("div",{className:"mt-4 inline-flex items-center gap-2 rounded-md bg-amber-50 px-3 py-2 text-sm text-amber-800 border border-amber-200",children:[e.jsx("span",{className:"h-2 w-2 rounded-full bg-amber-500 inline-block"}),"Report sent to supervisor — waiting for confirmation"]}):e.jsxs("div",{className:"mt-4 flex items-center gap-2",children:[e.jsx("button",{onClick:()=>F(t.id,"complete"),disabled:A===t.id,className:"inline-flex items-center rounded-md bg-emerald-600 px-3 py-1.5 text-white text-sm hover:bg-emerald-700 disabled:opacity-60",children:"Report service complete"}),e.jsx("button",{onClick:()=>Y(t.id),disabled:A===t.id,className:"inline-flex items-center rounded-md bg-red-600 px-3 py-1.5 text-white text-sm hover:bg-red-700 disabled:opacity-60",children:"Report service not complete"})]})]},t.id)})})}),e.jsx("div",{className:"lg:col-span-1",children:e.jsxs("div",{className:"rounded-lg border border-slate-200 bg-white p-4 lg:sticky lg:top-4",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsx("h3",{className:"text-base font-semibold text-slate-800",children:"Completed services"})}),e.jsxs("div",{className:"mt-3 grid grid-cols-2 gap-2",children:[e.jsx("select",{className:"w-full rounded-md border border-slate-300 bg-white px-2 py-1 text-sm",value:x,onChange:t=>D(Number(t.target.value)),children:Array.from({length:5}).map((t,s)=>{const a=new Date().getFullYear()-s;return e.jsx("option",{value:a,children:a},a)})}),e.jsx("select",{className:"w-full rounded-md border border-slate-300 bg-white px-2 py-1 text-sm",value:p,onChange:t=>B(Number(t.target.value)),children:Array.from({length:12}).map((t,s)=>{const a=s+1;return e.jsx("option",{value:a,children:a.toString().padStart(2,"0")},a)})})]}),_&&e.jsx("div",{className:"mt-2 text-xs text-red-600",children:_}),e.jsx("div",{className:"mt-3 space-y-2",children:T?e.jsx("div",{className:"text-sm text-slate-500",children:"Loading…"}):C.length===0?e.jsx("div",{className:"text-sm text-slate-500",children:"No completed services"}):C.map(t=>e.jsxs("button",{onClick:()=>O(s=>s===t.id?null:t.id),className:"w-full text-left rounded-md border border-slate-200 px-3 py-2 hover:bg-slate-50",children:[e.jsxs("div",{className:"text-sm font-medium text-slate-800",children:[t.vehicle_plate??"—"," • ",t.driver_username??"—"]}),e.jsx("div",{className:"text-xs text-slate-500",children:new Date(t.supervisor_decided_at||t.created_at).toLocaleString()}),Z===t.id&&e.jsxs("div",{className:"mt-2 text-xs text-slate-700 space-y-1",children:[e.jsxs("div",{children:["Start: ",String(t.service_start).slice(0,5)," • End: ",String(t.service_end).slice(0,5)]}),t.supervisor_reason?e.jsxs("div",{children:["Supervisor note: ",t.supervisor_reason]}):null]})]},t.id))})]})}),M&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:()=>d?null:u(!1)}),e.jsxs("div",{className:"relative z-10 w-full max-w-md rounded-lg border border-slate-200 bg-white p-4 shadow-lg",children:[e.jsx("div",{className:"text-base font-semibold text-slate-800",children:"Report service not complete"}),e.jsx("div",{className:"mt-2 text-sm text-slate-600",children:"Provide a reason"}),e.jsx("textarea",{value:E,onChange:t=>f(t.target.value),className:"mt-3 h-28 w-full resize-none rounded-md border border-slate-300 p-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-300",placeholder:"Reason (optional)",disabled:d}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{onClick:()=>d?null:u(!1),className:"inline-flex items-center rounded-md border border-slate-300 px-3 py-1.5 text-sm text-slate-700 hover:bg-slate-50",disabled:d,children:"Cancel"}),e.jsx("button",{onClick:J,className:"inline-flex items-center rounded-md bg-red-600 px-3 py-1.5 text-white text-sm hover:bg-red-700 disabled:opacity-60",disabled:d,children:"Submit"})]})]})]})]})}export{q as default};
