import{j as e}from"./index-DZTFkylD.js";import{r as n}from"./react-CzDbI3ao.js";const l="http://localhost:4000",F=()=>{const[x,y]=n.useState([]),[_,A]=n.useState([]),[S,k]=n.useState([]),[E,g]=n.useState(!1),[w,m]=n.useState(null),[$,j]=n.useState(null),[h,p]=n.useState(""),[f,u]=n.useState(new Set);function v(){const a=localStorage.getItem("token");a&&(g(!0),m(null),Promise.all([fetch(`${l}/api/manager/drivers/with-assignments`,{headers:{Authorization:`Bearer ${a}`}}),fetch(`${l}/api/manager/vehicles`,{headers:{Authorization:`Bearer ${a}`}}),fetch(`${l}/api/manager/manpower`,{headers:{Authorization:`Bearer ${a}`}})]).then(async([s,r,b])=>{const o=await s.json(),c=await r.json(),d=await b.json();if(!s.ok)throw new Error((o==null?void 0:o.error)||"Failed to load drivers");if(!r.ok)throw new Error((c==null?void 0:c.error)||"Failed to load vehicles");if(!b.ok)throw new Error((d==null?void 0:d.error)||"Failed to load manpower");const B=(o.drivers||[]).map(t=>({id:t.id,username:t.username,vehicle_id:t.vehicle_id??null,vehicle_plate:t.vehicle_plate||null,assigned_manpowers:Array.isArray(t.assigned_manpowers)?t.assigned_manpowers.map(i=>Number(i)):[],assigned_manpower_users:Array.isArray(t.assigned_manpower_users)?t.assigned_manpower_users.map(i=>({id:Number(i.id),username:String(i.username)})):[],zones:Array.isArray(t.zones)?t.zones.map(i=>({id:Number(i.id),name:i.name})):[]}));y(B),A((c.vehicles||[]).map(t=>({id:t.id,plate:t.plate,make:t.make,model:t.model}))),k((d.manpower||[]).map(t=>({id:t.id,username:t.username})))}).catch(s=>m((s==null?void 0:s.message)||"Failed to load")).finally(()=>g(!1)))}n.useEffect(()=>{v()},[]);function C(a){j(a.id),p(a.vehicle_id!=null?String(a.vehicle_id):""),u(new Set(a.assigned_manpowers||[]))}function I(a){u(s=>{const r=new Set(s);return r.has(a)?r.delete(a):r.add(a),r})}function N(){j(null),p(""),u(new Set)}async function z(a){const s=localStorage.getItem("token");if(s)try{h===""?await fetch(`${l}/api/manager/drivers/${a}/vehicle`,{method:"DELETE",headers:{Authorization:`Bearer ${s}`}}):await fetch(`${l}/api/manager/drivers/${a}/vehicle`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({vehicleId:Number(h)})}),await fetch(`${l}/api/manager/drivers/${a}/vehicle/manpowers`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({manpowerIds:Array.from(f)})}),N(),v()}catch(r){m((r==null?void 0:r.message)||"Failed to save assignments")}}return e.jsxs("div",{className:"p-6",children:[e.jsx("h2",{className:"text-2xl font-bold mb-4",children:"Vehicles & Drivers"}),w&&e.jsx("div",{className:"text-red-600 mb-3",children:w}),E?e.jsx("div",{children:"Loadingâ€¦"}):e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[x.map(a=>e.jsxs("div",{className:"bg-white rounded shadow p-4 border",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-lg font-semibold",children:a.username}),e.jsxs("span",{className:"text-sm text-gray-500",children:["#",a.id]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 text-sm",children:"Assigned Car:"}),e.jsx("span",{className:"ml-2 font-medium",children:a.vehicle_plate||"Not set"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 text-sm",children:"Assigned Manpowers:"}),e.jsx("span",{className:"ml-2 font-medium",children:a.assigned_manpower_users&&a.assigned_manpower_users.length?a.assigned_manpower_users.map(s=>s.username).join(", "):"None"})]}),e.jsx("div",{})]}),$===a.id?e.jsxs("div",{className:"mt-3 border-t pt-3 space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700",children:"Assign Vehicle"}),e.jsxs("select",{value:h,onChange:s=>p(s.target.value),className:"mt-1 w-full border rounded px-2 py-1 text-sm",children:[e.jsx("option",{value:"",children:"-- None --"}),_.map(s=>e.jsxs("option",{value:s.id,children:[s.plate,s.make||s.model?` (${[s.make,s.model].filter(Boolean).join(" ")})`:""]},s.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-1",children:"Assign Manpowers to Vehicle"}),e.jsx("div",{className:"max-h-40 overflow-auto border rounded p-2 space-y-1",children:S.map(s=>e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:f.has(s.id),onChange:()=>I(s.id)}),e.jsx("span",{children:s.username})]},s.id))})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>z(a.id),className:"px-3 py-1 bg-blue-600 text-white rounded text-sm",children:"Save"}),e.jsx("button",{onClick:N,className:"px-3 py-1 border rounded text-sm",children:"Cancel"})]})]}):e.jsx("div",{className:"mt-3",children:e.jsx("button",{onClick:()=>C(a),className:"text-blue-600 underline text-sm",children:"Manage manpowers"})})]},a.id)),!x.length&&e.jsx("div",{className:"text-gray-600",children:"No drivers found."})]})]})};export{F as default};
