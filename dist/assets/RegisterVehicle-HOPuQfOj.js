import{u as Y,j as e}from"./index-B34CxXhK.js";import{f as _,r as s}from"./react-BeLGUnOF.js";const c="http://localhost:4000",Q=()=>{const{t:a}=Y(),R=_(),[v,k]=s.useState(""),[E,C]=s.useState(""),[D,$]=s.useState(""),[m,B]=s.useState(!1),[h,p]=s.useState("existing"),[q,V]=s.useState([]),[b,A]=s.useState(""),[f,F]=s.useState(""),[j,I]=s.useState(""),[w,O]=s.useState(!1),[T,u]=s.useState(null),[P,U]=s.useState(null),[g,N]=s.useState(null),[x,y]=s.useState("");s.useEffect(()=>{const r=localStorage.getItem("token");r&&fetch(`${c}/api/manager/users?role=driver`,{headers:{Authorization:`Bearer ${r}`}}).then(async l=>{const n=await l.json();if(!l.ok)throw new Error((n==null?void 0:n.error)||"Failed to load drivers");V((n.users||[]).map(i=>({id:String(i.id),username:i.username})))}).catch(()=>{})},[]);async function H(r){var n;if(r.preventDefault(),u(null),U(null),!v.trim()){u("Plate is required");return}const l=localStorage.getItem("token");if(!l){u("You must be logged in as manager to register vehicles.");return}O(!0);try{let i=x;if(g){const o=await fetch(`${c}/api/manager/vehicles/upload-base64`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify({dataUrl:g})}),t=await o.json();if(!o.ok)throw new Error((t==null?void 0:t.error)||"Failed to upload image");i=t.image_url||i,y(i)}const z=await fetch(`${c}/api/manager/vehicles`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify({plate:v.trim(),make:E||void 0,model:D||void 0,imageUrl:i||void 0})}),d=await z.json();if(!z.ok)throw new Error((d==null?void 0:d.error)||"Failed to register vehicle");const M=d.vehicle.id;if(m)if(h==="existing"){if(!b)throw new Error("Please select a driver to assign");const o=await fetch(`${c}/api/manager/drivers/${b}/vehicle`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify({vehicleId:M})}),t=await o.json();if(!o.ok)throw new Error((t==null?void 0:t.error)||"Failed to assign vehicle to driver")}else{if(!f.trim()||!j.trim())throw new Error("Driver first and last name are required");const o=await fetch(`${c}/api/manager/drivers`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify({firstName:f.trim(),lastName:j.trim()})}),t=await o.json();if(!o.ok)throw new Error((t==null?void 0:t.error)||"Failed to create driver");const J=(n=t==null?void 0:t.driver)==null?void 0:n.id;if(!J)throw new Error("Driver created but id missing");const L=await fetch(`${c}/api/manager/drivers/${J}/vehicle`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify({vehicleId:M})}),S=await L.json();if(!L.ok)throw new Error((S==null?void 0:S.error)||"Failed to assign vehicle to new driver")}U(`Vehicle ${d.vehicle.plate} created${m?" and assigned":""}.`),k(""),C(""),$(""),B(!1),p("existing"),A(""),F(""),I(""),N(null),y("")}catch(i){u((i==null?void 0:i.message)||"Failed to register vehicle")}finally{O(!1)}}return e.jsxs("div",{className:"p-6 max-w-xl",children:[e.jsx("div",{className:"mb-2",children:e.jsxs("button",{onClick:()=>R(-1),className:"text-amber-600 underline text-sm",children:["← ",a("register.common.back")]})}),e.jsx("h2",{className:"text-2xl font-bold mb-4",children:a("register.vehicle.title")}),T&&e.jsx("div",{className:"rounded-lg border border-red-200 bg-red-50 p-3 text-red-700 mb-2",children:T}),P&&e.jsx("div",{className:"rounded-lg border border-emerald-200 bg-emerald-50 p-3 text-emerald-700 mb-2",children:P}),e.jsxs("form",{onSubmit:H,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-neutral-800",children:a("register.vehicle.plate")}),e.jsx("input",{className:"mt-1 w-full border rounded px-3 py-2",style:{borderColor:"#E5E7EB"},value:v,onChange:r=>k(r.target.value),required:!0})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-neutral-800",children:a("register.vehicle.make")}),e.jsx("input",{className:"mt-1 w-full border rounded px-3 py-2",style:{borderColor:"#E5E7EB"},value:E,onChange:r=>C(r.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-neutral-800",children:a("register.vehicle.model")}),e.jsx("input",{className:"mt-1 w-full border rounded px-3 py-2",style:{borderColor:"#E5E7EB"},value:D,onChange:r=>$(r.target.value)})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-neutral-800",children:a("register.vehicle.imageOptional")}),e.jsxs("div",{className:"mt-1 flex flex-col sm:flex-row items-start sm:items-center gap-3",children:[e.jsx("input",{type:"file",accept:"image/*",onChange:r=>{var i;const l=(i=r.target.files)==null?void 0:i[0];if(!l){N(null);return}const n=new FileReader;n.onload=()=>N(String(n.result||"")),n.readAsDataURL(l)},className:"block"}),e.jsx("input",{type:"url",placeholder:a("register.vehicle.imageUrlPlaceholder"),value:x,onChange:r=>y(r.target.value),className:"w-full sm:w-72 border rounded px-3 py-2"})]}),(g||x)&&e.jsx("div",{className:"mt-3",children:e.jsx("img",{src:g||x,alt:"Vehicle preview",className:"max-h-40 rounded border"})})]}),e.jsx("div",{className:"pt-2",children:e.jsxs("label",{className:"inline-flex items-center",children:[e.jsx("input",{type:"checkbox",className:"mr-2",checked:m,onChange:r=>B(r.target.checked)}),e.jsx("span",{children:a("register.vehicle.assignDriverOptional")})]})}),m&&e.jsxs("div",{className:"p-4 border rounded",children:[e.jsxs("div",{className:"space-x-4 mb-3",children:[e.jsxs("label",{className:"inline-flex items-center",children:[e.jsx("input",{type:"radio",name:"assignMode",value:"existing",checked:h==="existing",onChange:()=>p("existing"),className:"mr-2"}),e.jsx("span",{children:a("register.vehicle.assignExistingDriver")})]}),e.jsxs("label",{className:"inline-flex items-center ml-4",children:[e.jsx("input",{type:"radio",name:"assignMode",value:"new",checked:h==="new",onChange:()=>p("new"),className:"mr-2"}),e.jsx("span",{children:a("register.vehicle.createNewDriver")})]})]}),h==="existing"?e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-neutral-800",children:a("register.vehicle.selectDriver")}),e.jsxs("select",{value:b,onChange:r=>A(r.target.value),className:"mt-1 w-full border rounded px-2 py-2",children:[e.jsx("option",{value:"",children:"-- Select driver --"}),q.map(r=>e.jsx("option",{value:r.id,children:r.username},r.id))]})]}):e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-neutral-800",children:a("register.vehicle.driverFirstName")}),e.jsx("input",{className:"mt-1 w-full border rounded px-3 py-2",style:{borderColor:"#E5E7EB"},value:f,onChange:r=>F(r.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-neutral-800",children:a("register.vehicle.driverLastName")}),e.jsx("input",{className:"mt-1 w-full border rounded px-3 py-2",style:{borderColor:"#E5E7EB"},value:j,onChange:r=>I(r.target.value)})]})]})]}),e.jsx("button",{type:"submit",disabled:w,className:`px-4 py-2 text-white rounded ${w?"bg-amber-400":"bg-amber-600 hover:bg-amber-700"}`,children:w?"…":a("register.vehicle.button")})]})]})};export{Q as default};
