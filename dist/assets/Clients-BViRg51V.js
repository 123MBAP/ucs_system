import{j as e}from"./index-DMsqYpTw.js";import{f as K,u as Q,r as i,L}from"./react-BeLGUnOF.js";const h="http://localhost:4000",X=()=>{const b=K(),F=Q(),[c,P]=i.useState(null),[y,M]=i.useState([]),[v,B]=i.useState([]),[w,D]=i.useState({}),[d,R]=i.useState(null),[Z,u]=i.useState(!1),[C,k]=i.useState(null),[p,U]=i.useState(""),[T,q]=i.useState([]),[j,O]=i.useState(""),[o,S]=i.useState(new Set),[x,$]=i.useState(""),[_,N]=i.useState(null),[E,H]=i.useState(null);i.useEffect(()=>{const t=localStorage.getItem("token");t&&fetch(`${h}/api/me`,{headers:{Authorization:`Bearer ${t}`}}).then(async n=>{var r;const s=await n.json();if(!n.ok)throw new Error((s==null?void 0:s.error)||"Failed to load user");P(((r=s==null?void 0:s.user)==null?void 0:r.role)??null)}).catch(()=>{})},[]),i.useEffect(()=>{const t=localStorage.getItem("token");!t||c!=="manager"||fetch(`${h}/api/report/supervisors`,{headers:{Authorization:`Bearer ${t}`}}).then(async n=>{const s=await n.json();if(!n.ok)throw new Error((s==null?void 0:s.error)||"Failed to load supervisors");q(Array.isArray(s.supervisors)?s.supervisors:[])}).catch(()=>{})},[c]),i.useEffect(()=>{const t=localStorage.getItem("token");if(!t)return;if(u(!0),k(null),c==="chief"){fetch(`${h}/api/chief/clients`,{headers:{Authorization:`Bearer ${t}`}}).then(async s=>{const r=await s.json();if(!s.ok)throw new Error((r==null?void 0:r.error)||"Failed to load clients");B(Array.isArray(r.clients)?r.clients:[])}).catch(s=>k((s==null?void 0:s.message)||"Failed to load")).finally(()=>u(!1));return}fetch(`${h}/api/zones${c==="supervisor"?"?scope=supervisor":""}`,{headers:{Authorization:`Bearer ${t}`}}).then(async s=>{const r=await s.json();if(!s.ok)throw new Error((r==null?void 0:r.error)||"Failed to load zones");let a=(r.zones||[]).map(l=>({id:l.id,zone_name:l.zone_name,cell:l.cell,village:l.village,chief_username:l.chief_username??null,client_count:Number(l.client_count||0)}));return c==="manager"&&j&&(a=(r.zones||[]).filter(l=>String(l.supervisor_id||"")===j).map(l=>({id:l.id,zone_name:l.zone_name,cell:l.cell,village:l.village,chief_username:l.chief_username??null,client_count:Number(l.client_count||0)}))),M(a),a}).then(async s=>{const r=localStorage.getItem("token");if(!r)return;const a={};for(const l of s)try{const m=await fetch(`${h}/api/clients/by-zone/${l.id}`,{headers:{Authorization:`Bearer ${r}`}}),f=await m.json();m.ok&&(a[l.id]=Array.isArray(f.clients)?f.clients:[])}catch{}D(a)}).catch(s=>k((s==null?void 0:s.message)||"Failed to load")).finally(()=>u(!1))},[F.search,c,j]);const z=i.useMemo(()=>{const t=p.toLowerCase().trim();return t?v.filter(n=>{var s,r;return(n.username||"").toLowerCase().includes(t)||(n.phone_number||"").toLowerCase().includes(t)||`${((s=n.name)==null?void 0:s.first)||""} ${((r=n.name)==null?void 0:r.last)||""}`.trim().toLowerCase().includes(t)}):v},[v,p]),J=i.useMemo(()=>{const t=p.toLowerCase().trim();if(!t)return w;const n={};for(const[s,r]of Object.entries(w))n[Number(s)]=r.filter(a=>{var l,m;return(a.username||"").toLowerCase().includes(t)||(a.phone_number||"").toLowerCase().includes(t)||`${((l=a.name)==null?void 0:l.first)||""} ${((m=a.name)==null?void 0:m.last)||""}`.trim().toLowerCase().includes(t)});return n},[w,p]);function G(t){S(n=>{const s=new Set(n);return s.has(t)?s.delete(t):s.add(t),s}),H(t)}async function A(){const t=localStorage.getItem("token");if(!(!t||!o.size)&&confirm(`Delete ${o.size} client(s)?`)){u(!0);try{await Promise.all(Array.from(o).map(async n=>{await fetch(`${h}/api/clients/${n}`,{method:"DELETE",headers:{Authorization:`Bearer ${t}`}})})),S(new Set),b(0)}finally{u(!1)}}}async function I(){const t=localStorage.getItem("token"),n=Number(x);if(!(!t||!o.size||!Number.isFinite(n))){u(!0);try{await Promise.all(Array.from(o).map(async s=>{await fetch(`${h}/api/clients/${s}/zone`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({zoneId:n})})})),S(new Set),b(0)}finally{u(!1)}}}return e.jsxs("div",{className:"p-6 min-h-screen",style:{backgroundColor:"#F9FAFB"},children:[e.jsx("div",{className:"mb-2",children:e.jsx("button",{onClick:()=>b(-1),className:"text-amber-600 underline text-sm",children:"← Back"})}),e.jsx("h2",{className:"text-2xl font-bold mb-4",style:{color:"#1E1E1E"},children:"Clients"}),e.jsxs("div",{className:"mb-4 flex flex-wrap items-end gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm",style:{color:"#1E1E1E"},children:"Search"}),e.jsx("input",{value:p,onChange:t=>U(t.target.value),className:"mt-1 border rounded px-3 py-2 focus:outline-none focus:ring-2",style:{borderColor:"#E2E8F0"},placeholder:"Search by name, username or phone"})]}),c==="manager"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm",style:{color:"#1E1E1E"},children:"Supervisor"}),e.jsxs("select",{className:"mt-1 border rounded px-2 py-2 focus:outline-none focus:ring-2",style:{borderColor:"#E2E8F0"},value:j,onChange:t=>O(t.target.value),children:[e.jsx("option",{value:"",children:"All Supervisors"}),T.map(t=>e.jsx("option",{value:t.id,children:t.username},t.id))]})]})]}),C&&e.jsx("div",{className:"text-red-600 mb-3",children:C}),Z?e.jsx("div",{children:"Loading…"}):e.jsxs(e.Fragment,{children:[c==="chief"?e.jsx("div",{className:"overflow-x-auto bg-white border rounded shadow",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Photo"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Name"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Username"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Phone"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Amount"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsxs("tbody",{className:"bg-white divide-y divide-gray-200",children:[z.map(t=>{const n=t.name?`${t.name.first||""} ${t.name.last||""}`.trim():"";return e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2",children:t.profile_image_url?e.jsx("button",{onClick:()=>N(t.profile_image_url),className:"block",children:e.jsx("img",{src:t.profile_image_url,alt:"",className:"w-10 h-10 rounded-full object-cover cursor-zoom-in"})}):e.jsx("div",{className:"w-8 h-8 rounded-full bg-gray-200"})}),e.jsx("td",{className:"px-3 py-2",children:n||t.username}),e.jsx("td",{className:"px-3 py-2",children:t.username}),e.jsx("td",{className:"px-3 py-2",children:t.phone_number}),e.jsx("td",{className:"px-3 py-2",children:t.monthly_amount!=null?Number(t.monthly_amount).toLocaleString():"-"}),e.jsx("td",{className:"px-3 py-2",children:e.jsx(L,{to:`/payments?scope=chief&clientId=${encodeURIComponent(String(t.id))}&clientName=${encodeURIComponent((t.name?`${t.name.first||""} ${t.name.last||""}`.trim():"")||t.username)}`,className:"px-2 py-1 text-sm rounded",style:{backgroundColor:"#D97706",color:"#1E1E1E"},children:"Pay"})})]},t.id)}),!z.length&&e.jsx("tr",{children:e.jsx("td",{className:"px-3 py-4 text-gray-600",colSpan:5,children:"No clients."})})]})]})}):e.jsxs("div",{className:"overflow-x-auto bg-white border rounded shadow",children:[e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-10",children:"Sel"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Photo"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Name"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Username"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Phone"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Amount"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Zone"})]})}),e.jsxs("tbody",{className:"bg-white divide-y divide-gray-200",children:[y.flatMap(t=>{const n=J[t.id]||[],s=e.jsx("tr",{className:"bg-gray-50",children:e.jsx("td",{className:"px-3 py-2 text-gray-600",colSpan:6,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"font-semibold",children:[t.zone_name," ",e.jsxs("span",{className:"text-xs text-gray-500",children:["(#",t.id,")"]})]}),e.jsxs("div",{className:"text-sm text-gray-600",children:["Clients: ",n.length]})]})})},`zone-${t.id}`),r=n.flatMap(a=>{const l=a.name?`${a.name.first||""} ${a.name.last||""}`.trim():"",m=e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2",children:e.jsx("input",{type:"checkbox",checked:o.has(a.id),onChange:()=>G(a.id)})}),e.jsx("td",{className:"px-3 py-2",children:a.profile_image_url?e.jsx("button",{onClick:()=>N(a.profile_image_url),className:"block",children:e.jsx("img",{src:a.profile_image_url,alt:"",className:"w-10 h-10 rounded-full object-cover cursor-zoom-in"})}):e.jsx("div",{className:"w-8 h-8 rounded-full bg-gray-200"})}),e.jsx("td",{className:"px-3 py-2",children:l||a.username}),e.jsx("td",{className:"px-3 py-2",children:a.username}),e.jsx("td",{className:"px-3 py-2",children:a.phone_number}),e.jsx("td",{className:"px-3 py-2",children:a.monthly_amount!=null?Number(a.monthly_amount).toLocaleString():"-"}),e.jsx("td",{className:"px-3 py-2",children:t.zone_name})]},a.id),f=E===a.id&&o.size>0?e.jsx("tr",{className:"bg-gray-50",children:e.jsx("td",{className:"px-3 py-2",colSpan:7,children:e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsx("button",{disabled:!o.size,onClick:A,className:`px-3 py-2 rounded text-white ${o.size?"bg-red-600":"bg-gray-300 cursor-not-allowed"}`,children:"Delete Selected"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{className:"border rounded px-2 py-2 focus:outline-none focus:ring-2",style:{borderColor:"#E2E8F0"},value:x,onChange:g=>$(g.target.value),children:[e.jsx("option",{value:"",children:"Move to zone…"}),y.map(g=>e.jsx("option",{value:g.id,children:g.zone_name},g.id))]}),e.jsx("button",{disabled:!o.size||!x,onClick:I,className:`px-3 py-2 rounded text-white ${o.size&&x?"bg-amber-600":"bg-gray-300 cursor-not-allowed"}`,children:"Move Selected"})]})]})})},`actions-${a.id}`):null;return f?[m,f]:[m]});return[s,...r]}),!y.length&&e.jsx("tr",{children:e.jsx("td",{className:"px-3 py-4 text-gray-600",colSpan:6,children:"No zones."})})]})]}),(c==="manager"||c==="supervisor")&&!(o.size>0&&E!==null)&&e.jsxs("div",{className:"p-3 border-t flex items-center gap-3",children:[e.jsx("button",{disabled:!o.size,onClick:A,className:`px-3 py-2 rounded text-white ${o.size?"bg-red-600":"bg-gray-300 cursor-not-allowed"}`,children:"Delete Selected"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{className:"border rounded px-2 py-2 focus:outline-none focus:ring-2",style:{borderColor:"#E2E8F0"},value:x,onChange:t=>$(t.target.value),children:[e.jsx("option",{value:"",children:"Move to zone…"}),y.map(t=>e.jsx("option",{value:t.id,children:t.zone_name},t.id))]}),e.jsx("button",{disabled:!o.size||!x,onClick:I,className:`px-3 py-2 rounded text-white ${o.size&&x?"bg-amber-600":"bg-gray-300 cursor-not-allowed"}`,children:"Move Selected"})]})]})]}),d&&c==="chief"&&e.jsxs("div",{className:"mt-4 bg-white border rounded shadow p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Make Payment"}),e.jsxs("p",{className:"text-sm text-gray-600 mt-1",children:["For client: ",e.jsx("span",{className:"font-medium",children:(d.name?`${d.name.first||""} ${d.name.last||""}`.trim():"")||d.username})]})]}),e.jsx("button",{onClick:()=>R(null),className:"text-sm text-gray-600 hover:text-gray-800",children:"Clear"})]}),e.jsx("div",{className:"mt-3",children:e.jsx(L,{to:`/payments?scope=chief&clientId=${encodeURIComponent(String(d.id))}&clientName=${encodeURIComponent((d.name?`${d.name.first||""} ${d.name.last||""}`.trim():"")||d.username)}`,className:"inline-flex items-center px-4 py-2 rounded font-semibold",style:{backgroundColor:"#D97706",color:"#1E1E1E"},children:"Proceed to Payment"})})]}),_&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/60",onClick:()=>N(null)}),e.jsxs("div",{className:"relative z-10 max-w-3xl w-full",children:[e.jsx("img",{src:_,alt:"Client",className:"max-h-[80vh] w-full object-contain rounded-lg shadow-2xl bg-white"}),e.jsx("div",{className:"absolute top-2 right-2",children:e.jsx("button",{onClick:()=>N(null),className:"px-3 py-1 rounded-md text-white bg-black/60 hover:bg-black/80 text-sm",children:"Close"})})]})]})]})]})};export{X as default};
