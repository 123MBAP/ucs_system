import{j as e}from"./index-B9Qtw13a.js";import{R as n}from"./react-BeLGUnOF.js";function B(){const p="http://localhost:4000",[l,f]=n.useState("general"),[d,y]=n.useState(""),[k,$]=n.useState([]),[i,m]=n.useState(null),[x,b]=n.useState(!1),[c,v]=n.useState(null);let u=null,h=null;try{const t=localStorage.getItem("user"),s=t?JSON.parse(t):null;u=(s==null?void 0:s.role)??null,h=(s==null?void 0:s.id)??null}catch{}const C=u!=="client",S=u==="client",w=n.useRef({}),A=t=>{const s=w.current[t];s&&(s.scrollIntoView({behavior:"smooth",block:"center"}),s.classList.add("ring-2","ring-gray-300","ring-opacity-50"),setTimeout(()=>s.classList.remove("ring-2","ring-gray-300","ring-opacity-50"),1e3))};async function j(t){try{b(!0),v(null);const s=localStorage.getItem("token"),r=await fetch(`${p}/api/chat/messages?group=${encodeURIComponent(t)}&limit=100`,{headers:{Accept:"application/json",Authorization:s?`Bearer ${s}`:""}});if(!r.ok){const o=await r.json().catch(()=>({}));throw new Error((o==null?void 0:o.error)||`Failed to load messages (${r.status})`)}const a=await r.json(),g=Array.isArray(a==null?void 0:a.messages)?[...a.messages].reverse():[];$(g)}catch(s){v(String((s==null?void 0:s.message)||s))}finally{b(!1)}}n.useEffect(()=>{j(l)},[l]);async function M(){const t=d.trim();if(t)try{const s=localStorage.getItem("token"),r=await fetch(`${p}/api/chat/messages`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:s?`Bearer ${s}`:""},body:JSON.stringify({group:l,message:t,reply_to_id:(i==null?void 0:i.id)??null})});if(!r.ok){const a=await r.json().catch(()=>({}));throw new Error((a==null?void 0:a.error)||`Failed to send message (${r.status})`)}y(""),m(null),await j(l)}catch(s){alert(String((s==null?void 0:s.message)||s))}}const N=k.filter(t=>t.group===l);return e.jsx("div",{className:"p-3 sm:p-4 md:p-6 bg-gradient-to-br from-gray-50 to-white min-h-screen",children:e.jsxs("div",{className:"max-w-5xl w-full mx-auto bg-white rounded-xl sm:rounded-2xl shadow-md border border-neutral-200 overflow-hidden",children:[e.jsx("div",{className:"px-4 sm:px-6 py-3 sm:py-4 border-b border-neutral-200 bg-white text-neutral-900",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg sm:text-xl font-bold",children:"Chat Messages"}),e.jsx("div",{className:"text-xs sm:text-sm text-neutral-600 mt-1",children:l==="general"?"Community chat for all users":"Chat for workers (hidden from clients)"})]}),!S&&e.jsx("div",{className:"bg-neutral-100 border border-neutral-200 rounded-lg p-1",children:e.jsxs("div",{className:"flex text-xs sm:text-sm font-medium",children:[e.jsx("button",{className:`${l==="general"?"bg-neutral-800 text-white shadow-sm":"text-neutral-700 hover:text-neutral-900"} px-3 sm:px-4 py-1.5 sm:py-2 rounded-md transition-all duration-200`,onClick:()=>f("general"),children:"All Users"}),C&&e.jsx("button",{className:`${l==="workers"?"bg-neutral-800 text-white shadow-sm":"text-neutral-700 hover:text-neutral-900"} px-3 sm:px-4 py-1.5 sm:py-2 rounded-md transition-all duration-200`,onClick:()=>f("workers"),children:"Workers"})]})})]})}),e.jsxs("div",{className:"flex flex-col h-[64vh] sm:h-[66vh] md:h-[70vh]",children:[e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 sm:p-6 space-y-4 bg-white",children:[x&&e.jsx("div",{className:"flex justify-center",children:e.jsx("div",{className:"animate-pulse text-gray-500 text-sm",children:"Loading messages..."})}),c&&e.jsx("div",{className:"text-center text-red-600 text-sm bg-red-50 py-2 rounded-lg border border-red-200",children:c}),!x&&!c&&N.length===0&&e.jsxs("div",{className:"text-center text-gray-500 py-8",children:[e.jsx("div",{className:"text-lg font-medium mb-2",children:"No messages yet"}),e.jsx("div",{className:"text-sm",children:"Be the first to start the conversation!"})]}),!x&&!c&&N.map(t=>{const s=h!=null&&t.user_id===h,r=s?"You":t.client_name&&(t.client_name.first||t.client_name.last)?`${t.client_name.first??""} ${t.client_name.last??""}`.trim():t.client_username||t.user_username||"User",a=t.client_avatar||"",g=(t.message||"").slice(0,80),o=t.reply_client_name&&(t.reply_client_name.first||t.reply_client_name.last)?`${t.reply_client_name.first??""} ${t.reply_client_name.last??""}`.trim():t.reply_client_username||t.reply_user_username||null,_=t.reply_message;return e.jsx("div",{className:`flex ${s?"justify-end":"justify-start"} group`,ref:R=>{w.current[t.id]=R},children:e.jsxs("div",{className:`flex gap-3 max-w-[85%] ${s?"flex-row-reverse":""}`,children:[e.jsx("div",{className:`flex flex-col items-center ${s?"order-2":""}`,children:e.jsx("div",{className:"w-10 h-10 rounded-full overflow-hidden ring-2 ring-white shadow-sm bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center text-sm font-semibold text-gray-700",children:a?e.jsx("img",{src:a,alt:r,className:"w-full h-full object-cover"}):((r==null?void 0:r[0])||"U").toUpperCase()})}),e.jsxs("div",{className:`flex-1 ${s?"text-right":""}`,children:[e.jsxs("div",{className:`flex items-center gap-2 mb-1 ${s?"justify-end":"justify-start"}`,children:[e.jsx("span",{className:"text-sm font-semibold text-slate-700",children:r}),e.jsx("span",{className:"text-xs text-slate-500",children:new Date(t.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]}),e.jsxs("div",{className:"relative",children:[_&&e.jsx("div",{className:`mb-2 rounded-lg border-l-4 cursor-pointer transition-all hover:shadow-sm ${s?"border-l-neutral-400 bg-neutral-50 text-neutral-800":"border-l-gray-300 bg-gray-50 text-neutral-800"}`,onClick:()=>t.reply_id&&A(t.reply_id),children:e.jsxs("div",{className:"p-2",children:[e.jsxs("div",{className:"text-xs font-semibold mb-1",children:["Replying to ",o||"User"]}),e.jsx("div",{className:"text-xs text-gray-600 line-clamp-2",children:_})]})}),e.jsxs("div",{className:`relative inline-block max-w-full px-4 py-3 rounded-2xl shadow-sm transition-all ${s?"bg-neutral-800 text-white rounded-br-md":"bg-white text-neutral-800 border border-neutral-200 rounded-bl-md hover:border-neutral-300"}`,children:[e.jsx("button",{title:"Reply to this message",onClick:()=>m({id:t.id,name:r,snippet:g}),className:`absolute top-1/2 transform -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-all duration-200 ${s?"-left-12 bg-white text-neutral-800 hover:bg-gray-50":"-right-12 bg-gray-100 text-gray-600 hover:bg-gray-200"} w-8 h-8 rounded-full flex items-center justify-center shadow-md border`,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",className:"w-4 h-4",children:e.jsx("path",{d:"M10 8.5V6l-6 6 6 6v-2.5l4-.5a6 6 0 004.5-3.5l.5-1-1 .2A17 17 0 0010 8.5z"})})}),e.jsx("div",{className:"text-sm leading-relaxed whitespace-pre-wrap break-words",children:t.message})]})]})]})]})},t.id)})]}),e.jsxs("div",{className:"border-t border-neutral-200 bg-white/95 backdrop-blur-sm p-4 space-y-3",children:[i&&e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg border border-neutral-200 bg-neutral-50",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"text-sm font-semibold text-neutral-800 flex items-center gap-2",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",className:"w-4 h-4",children:e.jsx("path",{d:"M10 8.5V6l-6 6 6 6v-2.5l4-.5a6 6 0 004.5-3.5l.5-1-1 .2A17 17 0 0010 8.5z"})}),"Replying to ",i.name]}),e.jsx("div",{className:"text-sm text-gray-700 mt-1 line-clamp-2",children:i.snippet})]}),e.jsx("button",{onClick:()=>m(null),className:"text-neutral-700 hover:text-neutral-900 text-sm font-medium px-3 py-1 rounded-md hover:bg-gray-100 transition-colors",children:"Cancel"})]}),e.jsxs("div",{className:"flex items-end gap-3",children:[e.jsx("div",{className:"flex-1",children:e.jsx("textarea",{value:d,onChange:t=>y(t.target.value),className:"w-full px-4 py-3 rounded-xl border border-neutral-300 focus:outline-none focus:ring-2 focus:ring-neutral-700 focus:border-transparent bg-white text-neutral-900 placeholder-gray-500 resize-none",placeholder:l==="general"?"Type your message to everyone...":"Type your message to workers...",rows:1,style:{minHeight:"44px",maxHeight:"120px"},onInput:t=>{const s=t.target;s.style.height="auto",s.style.height=Math.min(s.scrollHeight,120)+"px"}})}),e.jsxs("button",{onClick:M,disabled:!d.trim(),className:"px-6 py-3 rounded-xl bg-neutral-900 text-white font-medium hover:bg-neutral-800 shadow-sm transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",className:"w-4 h-4",children:e.jsx("path",{d:"M3.478 2.404a.75.75 0 00-.926.941l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.404z"})}),"Send"]})]})]})]})]})})}export{B as default};
