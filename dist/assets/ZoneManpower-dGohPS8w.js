import{j as e}from"./index-8yk-1D8L.js";import{g as P,f as Z,r,L as I}from"./react-CzDbI3ao.js";const p="http://localhost:4000",_=()=>{const{id:c}=P(),S=Z(),[j,v]=r.useState(null),[b,z]=r.useState([]),[$,E]=r.useState([]),[C,y]=r.useState(!1),[N,u]=r.useState(null),[h,x]=r.useState(!1),[i,d]=r.useState([]),[g,f]=r.useState("");function w(){const t=localStorage.getItem("token");!t||!c||(y(!0),u(null),Promise.all([fetch(`${p}/api/zones/${c}`,{headers:{Authorization:`Bearer ${t}`}}),fetch(`${p}/api/manager/manpower/by-zone/${c}`,{headers:{Authorization:`Bearer ${t}`}}),fetch(`${p}/api/zones`,{headers:{Authorization:`Bearer ${t}`}})]).then(async([n,s,m])=>{const a=await n.json(),o=await s.json(),l=await m.json();if(!n.ok)throw new Error((a==null?void 0:a.error)||"Failed to load zone");if(!s.ok)throw new Error((o==null?void 0:o.error)||"Failed to load manpower");if(!m.ok)throw new Error((l==null?void 0:l.error)||"Failed to load zones");v({id:a.zone.id,zone_name:a.zone.zone_name}),z(Array.isArray(o.manpower)?o.manpower:[]),E((l.zones||[]).map(k=>({id:String(k.id),name:k.zone_name})))}).catch(n=>u((n==null?void 0:n.message)||"Failed to load")).finally(()=>y(!1)))}r.useEffect(()=>{w()},[c]);function A(){x(t=>!t),d([])}function M(t){d(n=>n.includes(t)?n.filter(s=>s!==t):[...n,t])}function B(){const t=localStorage.getItem("token");!t||!i.length||!g||Promise.all(i.map(n=>fetch(`${p}/api/manager/manpower/${n}/zone`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({zoneId:Number(g)})}))).then(async n=>{const m=(await Promise.all(n.map(async a=>{var o;return a.ok?null:((o=await a.json())==null?void 0:o.error)||"error"}))).find(a=>a);if(m)throw new Error(m);d([]),f(""),x(!1),w()}).catch(n=>u((n==null?void 0:n.message)||"Failed to move manpower"))}function F(){const t=localStorage.getItem("token");!t||!i.length||!window.confirm(`Unassign ${i.length} selected manpower from any zone?`)||Promise.all(i.map(s=>fetch(`${p}/api/manager/manpower/${s}/zone`,{method:"DELETE",headers:{Authorization:`Bearer ${t}`}}))).then(async s=>{const a=(await Promise.all(s.map(async o=>{var l;return o.ok?null:((l=await o.json())==null?void 0:l.error)||"error"}))).find(o=>o);if(a)throw new Error(a);d([]),x(!1),w()}).catch(s=>u((s==null?void 0:s.message)||"Failed to unassign manpower"))}return e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("button",{onClick:()=>S(-1),className:"text-blue-600 underline text-sm",children:"← Back"}),c&&e.jsx(I,{to:`/register-manpower?zoneId=${c}`,className:"text-blue-600 underline text-sm",children:"Add Manpower"})]}),e.jsxs("h2",{className:"text-2xl font-bold mb-4",children:["Manpower in ",j?j.zone_name:"Zone"]}),N&&e.jsx("div",{className:"text-red-600 mb-3",children:N}),C?e.jsx("div",{children:"Loading…"}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-3 flex items-center justify-between",children:[e.jsx("button",{onClick:A,className:"px-3 py-1 border rounded text-sm",children:h?"Cancel select":"Select"}),h&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{value:g,onChange:t=>f(t.target.value),className:"border rounded px-2 py-1 text-sm",children:[e.jsx("option",{value:"",children:"-- Move to zone --"}),$.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsx("button",{disabled:!i.length||!g,onClick:B,className:"px-3 py-1 bg-blue-600 text-white rounded text-sm disabled:opacity-50",children:"Move"}),e.jsx("button",{disabled:!i.length,onClick:F,className:"px-3 py-1 bg-red-600 text-white rounded text-sm disabled:opacity-50",children:"Unassign"}),e.jsx("span",{className:"mx-2 text-gray-300",children:"|"}),e.jsx("button",{onClick:()=>{x(!1),d([])},className:"px-3 py-1 border rounded text-sm",children:"Save"}),e.jsx("button",{onClick:()=>{x(!1),d([]),f("")},className:"px-3 py-1 border rounded text-sm",children:"Cancel"})]})]}),e.jsx("div",{className:"overflow-x-auto bg-white border rounded shadow",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[h&&e.jsx("th",{className:"px-3 py-2"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Username"})]})}),e.jsxs("tbody",{className:"bg-white divide-y divide-gray-200",children:[b.map(t=>e.jsxs("tr",{children:[h&&e.jsx("td",{className:"px-3 py-2",children:e.jsx("input",{type:"checkbox",checked:i.includes(t.id),onChange:()=>M(t.id)})}),e.jsx("td",{className:"px-3 py-2",children:t.username})]},t.id)),!b.length&&e.jsx("tr",{children:e.jsx("td",{className:"px-3 py-4 text-gray-600",colSpan:h?2:1,children:"No manpower in this zone."})})]})]})})]})]})};export{_ as default};
