import{j as e}from"./index-DaGMaRVu.js";import{r as t}from"./react-CzDbI3ao.js";import{L as P}from"./LoadingSpinner-6XlBvmUP.js";const w="http://localhost:4000",q=()=>{const[p,F]=t.useState(null),[U,S]=t.useState(!1),[k,u]=t.useState(null),[C,V]=t.useState(""),[y,_]=t.useState([]),[j,O]=t.useState([]),[N,A]=t.useState([]),[f,z]=t.useState([]),[b,W]=t.useState([]),[n,c]=t.useState(null),[x,L]=t.useState(!1);t.useEffect(()=>{const s=localStorage.getItem("token");s&&fetch(`${w}/api/me`,{headers:{Authorization:`Bearer ${s}`}}).then(async l=>{var a;const r=await l.json();F(((a=r==null?void 0:r.user)==null?void 0:a.role)??null)}).catch(()=>{})},[]),t.useEffect(()=>{const s=localStorage.getItem("token");!s||p!=="manager"||(S(!0),u(null),fetch(`${w}/api/manager/workers-summary`,{headers:{Authorization:`Bearer ${s}`}}).then(async l=>{const r=await l.json();if(!l.ok)throw new Error((r==null?void 0:r.error)||"Failed to load workers");_(Array.isArray(r.supervisors)?r.supervisors.map(a=>({id:a.id,username:a.username,first_name:a.first_name??null,last_name:a.last_name??null,salary:a.salary!=null?Number(a.salary):null,zones:Array.isArray(a.zones)?a.zones:[]})):[]),O(Array.isArray(r.chiefs)?r.chiefs.map(a=>({id:a.id,username:a.username,first_name:a.first_name??null,last_name:a.last_name??null,zones:Array.isArray(a.zones)?a.zones:[]})):[]),A(Array.isArray(r.manpower)?r.manpower.map(a=>({id:a.id,username:a.username,first_name:a.first_name??null,last_name:a.last_name??null,salary:a.salary!=null?Number(a.salary):null})):[]),z(Array.isArray(r.drivers)?r.drivers.map(a=>({id:a.id,username:a.username,first_name:a.first_name??null,last_name:a.last_name??null,salary:a.salary!=null?Number(a.salary):null})):[]),W(Array.isArray(r.vehicles)?r.vehicles:[])}).catch(l=>u((l==null?void 0:l.message)||"Failed to load workers")).finally(()=>S(!1)))},[p]);const i=C.toLowerCase().trim(),E=t.useMemo(()=>i?y.filter(s=>s.username.toLowerCase().includes(i)):y,[i,y]),I=t.useMemo(()=>i?j.filter(s=>s.username.toLowerCase().includes(i)):j,[i,j]),M=t.useMemo(()=>i?N.filter(s=>s.username.toLowerCase().includes(i)):N,[i,N]),B=t.useMemo(()=>i?f.filter(s=>s.username.toLowerCase().includes(i)):f,[i,f]),$=t.useMemo(()=>i?b.filter(s=>(s.plate||"").toLowerCase().includes(i)):b,[i,b]);async function g(s,l){const r=localStorage.getItem("token");if(!r)return;const a=Number(l);if(Number.isFinite(a)){L(!0);try{const m=await fetch(`${w}/api/manager/salaries`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({userId:s,amount:a})}),v=await m.json();if(!m.ok)throw new Error((v==null?void 0:v.error)||"Failed to save salary");const D=d=>d.map(o=>o.id===s?{...o,salary:a}:o);A(d=>D(d)),z(d=>D(d)),_(d=>d.map(o=>o.id===s?{...o,salary:a}:o)),c(null)}catch(m){u((m==null?void 0:m.message)||"Failed to save salary")}finally{L(!1)}}}const h=({label:s,target:l})=>e.jsx("a",{href:l,className:"px-3 py-1 rounded bg-amber-100 text-amber-800 hover:bg-amber-200 text-sm",children:s});return p!=="manager"?e.jsxs("div",{className:"p-6",children:[e.jsx("h2",{className:"text-2xl font-bold mb-4",children:"Workers"}),e.jsx("div",{className:"text-red-600",children:"Only managers can view this page."})]}):e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Workers"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{label:"Supervisors",target:"#supervisors"}),e.jsx(h,{label:"Chiefs",target:"#chiefs"}),e.jsx(h,{label:"Manpower",target:"#manpower"}),e.jsx(h,{label:"Drivers",target:"#drivers"}),e.jsx(h,{label:"Vehicles",target:"#vehicles"})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm text-gray-700",children:"Search"}),e.jsx("input",{value:C,onChange:s=>V(s.target.value),className:"mt-1 border rounded px-3 py-2 w-full max-w-md",placeholder:"Search by username or plate"})]}),k&&e.jsx("div",{className:"text-red-600 mb-3",children:k}),U?e.jsxs("div",{className:"py-12 flex items-center gap-3 text-amber-700",children:[e.jsx(P,{size:24}),e.jsx("span",{children:"Loadingâ€¦"})]}):e.jsxs("div",{className:"space-y-8",children:[e.jsxs("section",{id:"supervisors",className:"bg-white rounded-lg shadow overflow-hidden",children:[e.jsx("div",{className:"px-4 py-3 font-semibold border-b",children:"Supervisors"}),e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left",children:"Name"}),e.jsx("th",{className:"px-4 py-3 text-left",children:"Username"}),e.jsx("th",{className:"px-4 py-3 text-left",children:"Zones"}),e.jsx("th",{className:"px-4 py-3 text-right",children:"Salary"}),e.jsx("th",{className:"px-4 py-3 text-left",children:"Action"})]})}),e.jsxs("tbody",{children:[E.map(s=>{var l;return e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"px-4 py-3",children:[s.first_name,s.last_name].filter(Boolean).join(" ")||"-"}),e.jsx("td",{className:"px-4 py-3",children:s.username}),e.jsx("td",{className:"px-4 py-3",children:(l=s.zones)!=null&&l.length?s.zones.map(r=>r.name).join(", "):"-"}),e.jsx("td",{className:"px-4 py-3 text-right",children:s.salary!=null?Number(s.salary).toLocaleString():"-"}),e.jsx("td",{className:"px-4 py-3",children:(n==null?void 0:n.userId)===s.id?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"number",className:"border rounded px-2 py-1 w-32",value:n.amount,onChange:r=>c({userId:s.id,amount:r.target.value})}),e.jsx("button",{disabled:x,onClick:()=>g(s.id,n.amount),className:"px-3 py-1 rounded bg-green-600 text-white",children:"Save"}),e.jsx("button",{disabled:x,onClick:()=>c(null),className:"px-3 py-1 rounded bg-gray-200",children:"Cancel"})]}):e.jsx("button",{onClick:()=>c({userId:s.id,amount:s.salary!=null?String(s.salary):""}),className:"px-3 py-1 rounded bg-amber-500 text-black",children:"Edit Salary"})})]},s.id)}),!E.length&&e.jsx("tr",{children:e.jsx("td",{className:"px-4 py-6 text-gray-500",colSpan:4,children:"No supervisors found."})})]})]})]}),e.jsxs("section",{id:"chiefs",className:"bg-white rounded-lg shadow overflow-hidden",children:[e.jsx("div",{className:"px-4 py-3 font-semibold border-b",children:"Chiefs"}),e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left",children:"Name"}),e.jsx("th",{className:"px-4 py-3 text-left",children:"Username"}),e.jsx("th",{className:"px-4 py-3 text-left",children:"Zones"})]})}),e.jsxs("tbody",{children:[I.map(s=>{var l;return e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"px-4 py-3",children:[s.first_name,s.last_name].filter(Boolean).join(" ")||"-"}),e.jsx("td",{className:"px-4 py-3",children:s.username}),e.jsx("td",{className:"px-4 py-3",children:(l=s.zones)!=null&&l.length?s.zones.map(r=>r.name).join(", "):"-"})]},s.id)}),!I.length&&e.jsx("tr",{children:e.jsx("td",{className:"px-4 py-6 text-gray-500",colSpan:2,children:"No chiefs found."})})]})]})]}),e.jsxs("section",{id:"manpower",className:"bg-white rounded-lg shadow overflow-hidden",children:[e.jsx("div",{className:"px-4 py-3 font-semibold border-b",children:"Manpower"}),e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left",children:"Name"}),e.jsx("th",{className:"px-4 py-3 text-left",children:"Username"}),e.jsx("th",{className:"px-4 py-3 text-right",children:"Salary"}),e.jsx("th",{className:"px-4 py-3 text-left",children:"Action"})]})}),e.jsxs("tbody",{children:[M.map(s=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"px-4 py-3",children:[s.first_name,s.last_name].filter(Boolean).join(" ")||"-"}),e.jsx("td",{className:"px-4 py-3",children:s.username}),e.jsx("td",{className:"px-4 py-3 text-right",children:s.salary!=null?Number(s.salary).toLocaleString():"-"}),e.jsx("td",{className:"px-4 py-3",children:(n==null?void 0:n.userId)===s.id?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"number",className:"border rounded px-2 py-1 w-32",value:n.amount,onChange:l=>c({userId:s.id,amount:l.target.value})}),e.jsx("button",{disabled:x,onClick:()=>g(s.id,n.amount),className:"px-3 py-1 rounded bg-green-600 text-white",children:"Save"}),e.jsx("button",{disabled:x,onClick:()=>c(null),className:"px-3 py-1 rounded bg-gray-200",children:"Cancel"})]}):e.jsx("button",{onClick:()=>c({userId:s.id,amount:s.salary!=null?String(s.salary):""}),className:"px-3 py-1 rounded bg-amber-500 text-black",children:"Edit Salary"})})]},s.id)),!M.length&&e.jsx("tr",{children:e.jsx("td",{className:"px-4 py-6 text-gray-500",colSpan:3,children:"No manpower found."})})]})]})]}),e.jsxs("section",{id:"drivers",className:"bg-white rounded-lg shadow overflow-hidden",children:[e.jsx("div",{className:"px-4 py-3 font-semibold border-b",children:"Drivers"}),e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left",children:"Name"}),e.jsx("th",{className:"px-4 py-3 text-left",children:"Username"}),e.jsx("th",{className:"px-4 py-3 text-right",children:"Salary"}),e.jsx("th",{className:"px-4 py-3 text-left",children:"Action"})]})}),e.jsxs("tbody",{children:[B.map(s=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"px-4 py-3",children:[s.first_name,s.last_name].filter(Boolean).join(" ")||"-"}),e.jsx("td",{className:"px-4 py-3",children:s.username}),e.jsx("td",{className:"px-4 py-3 text-right",children:s.salary!=null?Number(s.salary).toLocaleString():"-"}),e.jsx("td",{className:"px-4 py-3",children:(n==null?void 0:n.userId)===s.id?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"number",className:"border rounded px-2 py-1 w-32",value:n.amount,onChange:l=>c({userId:s.id,amount:l.target.value})}),e.jsx("button",{disabled:x,onClick:()=>g(s.id,n.amount),className:"px-3 py-1 rounded bg-green-600 text-white",children:"Save"}),e.jsx("button",{disabled:x,onClick:()=>c(null),className:"px-3 py-1 rounded bg-gray-200",children:"Cancel"})]}):e.jsx("button",{onClick:()=>c({userId:s.id,amount:s.salary!=null?String(s.salary):""}),className:"px-3 py-1 rounded bg-amber-500 text-black",children:"Edit Salary"})})]},s.id)),!B.length&&e.jsx("tr",{children:e.jsx("td",{className:"px-4 py-6 text-gray-500",colSpan:3,children:"No drivers found."})})]})]})]}),e.jsxs("section",{id:"vehicles",className:"bg-white rounded-lg shadow overflow-hidden",children:[e.jsx("div",{className:"px-4 py-3 font-semibold border-b",children:"Vehicles"}),e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left",children:"Plate"}),e.jsx("th",{className:"px-4 py-3 text-left",children:"Make"}),e.jsx("th",{className:"px-4 py-3 text-left",children:"Model"}),e.jsx("th",{className:"px-4 py-3 text-left",children:"Supervisor ID"})]})}),e.jsxs("tbody",{children:[$.map(s=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"px-4 py-3",children:s.plate}),e.jsx("td",{className:"px-4 py-3",children:s.make||""}),e.jsx("td",{className:"px-4 py-3",children:s.model||""}),e.jsx("td",{className:"px-4 py-3",children:s.supervisor_id??""})]},s.id)),!$.length&&e.jsx("tr",{children:e.jsx("td",{className:"px-4 py-6 text-gray-500",colSpan:4,children:"No vehicles found."})})]})]})]})]})]})};export{q as default};
