import{j as e}from"./index-CdjKjvMW.js";import{r as l}from"./react-CzDbI3ao.js";import{L as le}from"./LoadingSpinner-TlVx4c7g.js";const u="http://localhost:4000",ce=()=>{const[v,G]=l.useState(null),[K,M]=l.useState(!1),[O,S]=l.useState(null),[F,X]=l.useState(""),[k,D]=l.useState([]),[C,Y]=l.useState([]),[_,P]=l.useState([]),[A,R]=l.useState([]),[L,z]=l.useState([]),[T,E]=l.useState({}),[V,y]=l.useState({}),[f,$]=l.useState({}),[j,N]=l.useState({}),[J,b]=l.useState({}),[ee,U]=l.useState(!1),[se,ae]=l.useState(""),[d,x]=l.useState(null),[h,W]=l.useState(!1);l.useEffect(()=>{const s=localStorage.getItem("token");s&&fetch(`${u}/api/me`,{headers:{Authorization:`Bearer ${s}`}}).then(async r=>{var t;const a=await r.json();G(((t=a==null?void 0:a.user)==null?void 0:t.role)??null)}).catch(()=>{})},[]),l.useEffect(()=>{const s=localStorage.getItem("token");!s||v!=="manager"||(M(!0),S(null),fetch(`${u}/api/manager/workers-summary`,{headers:{Authorization:`Bearer ${s}`}}).then(async r=>{const a=await r.json();if(!r.ok)throw new Error((a==null?void 0:a.error)||"Failed to load workers");D(Array.isArray(a.supervisors)?a.supervisors.map(t=>({id:t.id,username:t.username,first_name:t.first_name??null,last_name:t.last_name??null,salary:t.salary!=null?Number(t.salary):null,zones:Array.isArray(t.zones)?t.zones:[]})):[]),Y(Array.isArray(a.chiefs)?a.chiefs.map(t=>({id:t.id,username:t.username,first_name:t.first_name??null,last_name:t.last_name??null,zones:Array.isArray(t.zones)?t.zones:[]})):[]),P(Array.isArray(a.manpower)?a.manpower.map(t=>({id:t.id,username:t.username,first_name:t.first_name??null,last_name:t.last_name??null,salary:t.salary!=null?Number(t.salary):null})):[]),R(Array.isArray(a.drivers)?a.drivers.map(t=>({id:t.id,username:t.username,first_name:t.first_name??null,last_name:t.last_name??null,salary:t.salary!=null?Number(t.salary):null})):[]),z(Array.isArray(a.vehicles)?a.vehicles:[])}).catch(r=>S((r==null?void 0:r.message)||"Failed to load workers")).finally(()=>M(!1)))},[v]);const i=F.toLowerCase().trim(),w=(s,r)=>{const a=(s||"").toLowerCase().trim(),t=(r||"").toLowerCase().trim(),n=[a,t].filter(Boolean).join(" ").trim();return!!n&&n.includes(i)},H=l.useMemo(()=>i?k.filter(s=>s.username.toLowerCase().includes(i)||w(s.first_name,s.last_name)):k,[i,k]),Z=l.useMemo(()=>i?C.filter(s=>s.username.toLowerCase().includes(i)||w(s.first_name,s.last_name)):C,[i,C]),q=l.useMemo(()=>i?_.filter(s=>s.username.toLowerCase().includes(i)||w(s.first_name,s.last_name)):_,[i,_]),Q=l.useMemo(()=>i?A.filter(s=>s.username.toLowerCase().includes(i)||w(s.first_name,s.last_name)):A,[i,A]),B=l.useMemo(()=>i?L.filter(s=>(s.plate||"").toLowerCase().includes(i)):L,[i,L]);async function I(s,r){const a=localStorage.getItem("token");if(!a)return;const t=Number(r);if(Number.isFinite(t)){W(!0);try{const n=await fetch(`${u}/api/manager/salaries`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({userId:s,amount:t})}),o=await n.json();if(!n.ok)throw new Error((o==null?void 0:o.error)||"Failed to save salary");const m=c=>c.map(p=>p.id===s?{...p,salary:t}:p);P(c=>m(c)),R(c=>m(c)),D(c=>c.map(p=>p.id===s?{...p,salary:t}:p)),x(null)}catch(n){S((n==null?void 0:n.message)||"Failed to save salary")}finally{W(!1)}}}async function te(s){const r=localStorage.getItem("token");if(r){b(a=>({...a,[s]:null})),N(a=>({...a,[s]:!0}));try{let a=f[s]||"";const t=V[s]||null;if(t){const m=await fetch(`${u}/api/manager/vehicles/upload-base64`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({dataUrl:t})}),c=await m.json();if(!m.ok)throw new Error((c==null?void 0:c.error)||"Failed to upload image");a=c.image_url||a}if(!a)throw new Error("Please choose a file or paste an image URL");const n=await fetch(`${u}/api/manager/vehicles/${s}`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({imageUrl:a})}),o=await n.json();if(!n.ok)throw new Error((o==null?void 0:o.error)||"Failed to update vehicle");z(m=>m.map(c=>{var p;return c.id===s?{...c,image_url:((p=o.vehicle)==null?void 0:p.image_url)??a}:c})),E(m=>({...m,[s]:!1})),y(m=>({...m,[s]:null})),$(m=>({...m,[s]:""}))}catch(a){b(t=>({...t,[s]:(a==null?void 0:a.message)||"Failed to save image"}))}finally{N(a=>({...a,[s]:!1}))}}}async function re(s){const r=localStorage.getItem("token");if(r){b(a=>({...a,[s]:null})),N(a=>({...a,[s]:!0}));try{const a=await fetch(`${u}/api/manager/vehicles/${s}`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({imageUrl:null})}),t=await a.json();if(!a.ok)throw new Error((t==null?void 0:t.error)||"Failed to delete image");z(n=>n.map(o=>o.id===s?{...o,image_url:null}:o)),E(n=>({...n,[s]:!1})),y(n=>({...n,[s]:null})),$(n=>({...n,[s]:""}))}catch(a){b(t=>({...t,[s]:(a==null?void 0:a.message)||"Failed to delete image"}))}finally{N(a=>({...a,[s]:!1}))}}}const g=({label:s,target:r})=>e.jsx("a",{href:r,className:"px-2 py-1 sm:px-3 rounded bg-amber-100 text-amber-800 hover:bg-amber-200 text-xs sm:text-sm whitespace-nowrap",children:s});return v!=="manager"?e.jsxs("div",{className:"p-6",children:[e.jsx("h2",{className:"text-2xl font-bold mb-4",children:"Workers"}),e.jsx("div",{className:"text-red-600",children:"Only managers can view this page."})]}):e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Workers"}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(g,{label:"Supervisors",target:"#supervisors"}),e.jsx(g,{label:"Chiefs",target:"#chiefs"}),e.jsx(g,{label:"Manpower",target:"#manpower"}),e.jsx(g,{label:"Drivers",target:"#drivers"}),e.jsx(g,{label:"Vehicles",target:"#vehicles"})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm text-gray-700",children:"Search"}),e.jsx("input",{value:F,onChange:s=>X(s.target.value),className:"mt-1 border rounded px-3 py-2 w-full max-w-md",placeholder:"Search by name, username or plate"})]}),O&&e.jsx("div",{className:"text-red-600 mb-3",children:O}),K?e.jsxs("div",{className:"py-12 flex items-center gap-3 text-amber-700",children:[e.jsx(le,{size:24}),e.jsx("span",{children:"Loading…"})]}):e.jsxs("div",{className:"space-y-8",children:[e.jsxs("section",{id:"supervisors",className:"bg-white rounded-lg shadow overflow-hidden",children:[e.jsx("div",{className:"px-4 py-3 font-semibold border-b",children:"Supervisors"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-[720px] sm:min-w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left",children:"Name"}),e.jsx("th",{className:"px-4 py-3 text-left",children:"Username"}),e.jsx("th",{className:"px-4 py-3 text-left",children:"Zones"}),e.jsx("th",{className:"px-4 py-3 text-right",children:"Salary"}),e.jsx("th",{className:"px-4 py-3 text-left",children:"Action"})]})}),e.jsxs("tbody",{children:[H.map(s=>{var r;return e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"px-4 py-3",children:[s.first_name,s.last_name].filter(Boolean).join(" ")||"-"}),e.jsx("td",{className:"px-4 py-3",children:s.username}),e.jsx("td",{className:"px-4 py-3",children:(r=s.zones)!=null&&r.length?s.zones.map(a=>a.name).join(", "):"-"}),e.jsx("td",{className:"px-4 py-3 text-right",children:s.salary!=null?Number(s.salary).toLocaleString():"-"}),e.jsx("td",{className:"px-4 py-3",children:(d==null?void 0:d.userId)===s.id?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"number",className:"border rounded px-2 py-1 w-32",value:d.amount,onChange:a=>x({userId:s.id,amount:a.target.value})}),e.jsx("button",{disabled:h,onClick:()=>I(s.id,d.amount),className:"px-2 sm:px-3 py-1 rounded bg-green-600 text-white text-xs sm:text-sm whitespace-nowrap",children:"Save"}),e.jsx("button",{disabled:h,onClick:()=>x(null),className:"px-2 sm:px-3 py-1 rounded bg-gray-200 text-xs sm:text-sm whitespace-nowrap",children:"Cancel"})]}):e.jsx("button",{onClick:()=>x({userId:s.id,amount:s.salary!=null?String(s.salary):""}),className:"px-2 sm:px-3 py-1 rounded bg-amber-500 text-black text-xs sm:text-sm whitespace-nowrap",children:"Edit Salary"})})]},s.id)}),!H.length&&e.jsx("tr",{children:e.jsx("td",{className:"px-4 py-6 text-gray-500",colSpan:4,children:"No supervisors found."})})]})]})})]}),ee&&e.jsx("div",{className:"fixed inset-0 z-50 bg-black/70 flex items-center justify-center p-4",role:"dialog","aria-modal":"true",onClick:()=>U(!1),children:e.jsxs("div",{className:"relative max-w-4xl w-full",onClick:s=>s.stopPropagation(),children:[e.jsx("img",{src:se,alt:"Vehicle",className:"w-full h-auto rounded-lg shadow-lg"}),e.jsx("button",{type:"button",onClick:()=>U(!1),className:"absolute top-2 right-2 inline-flex items-center justify-center rounded-full bg-black/60 text-white w-9 h-9 hover:bg-black/80 focus:outline-none focus:ring-2 focus:ring-amber-500","aria-label":"Close",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",className:"w-5 h-5",children:e.jsx("path",{fillRule:"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",clipRule:"evenodd"})})})]})}),e.jsxs("section",{id:"chiefs",className:"bg-white rounded-lg shadow overflow-hidden",children:[e.jsx("div",{className:"px-4 py-3 font-semibold border-b",children:"Chiefs"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-[720px] sm:min-w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left",children:"Name"}),e.jsx("th",{className:"px-4 py-3 text-left",children:"Username"}),e.jsx("th",{className:"px-4 py-3 text-left",children:"Zones"})]})}),e.jsxs("tbody",{children:[Z.map(s=>{var r;return e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"px-4 py-3",children:[s.first_name,s.last_name].filter(Boolean).join(" ")||"-"}),e.jsx("td",{className:"px-4 py-3",children:s.username}),e.jsx("td",{className:"px-4 py-3",children:(r=s.zones)!=null&&r.length?s.zones.map(a=>a.name).join(", "):"-"})]},s.id)}),!Z.length&&e.jsx("tr",{children:e.jsx("td",{className:"px-4 py-6 text-gray-500",colSpan:2,children:"No chiefs found."})})]})]})})]}),e.jsxs("section",{id:"manpower",className:"bg-white rounded-lg shadow overflow-hidden",children:[e.jsx("div",{className:"px-4 py-3 font-semibold border-b",children:"Manpower"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-[720px] sm:min-w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left",children:"Name"}),e.jsx("th",{className:"px-4 py-3 text-left",children:"Username"}),e.jsx("th",{className:"px-4 py-3 text-right",children:"Salary"}),e.jsx("th",{className:"px-4 py-3 text-left",children:"Action"})]})}),e.jsxs("tbody",{children:[q.map(s=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"px-4 py-3",children:[s.first_name,s.last_name].filter(Boolean).join(" ")||"-"}),e.jsx("td",{className:"px-4 py-3",children:s.username}),e.jsx("td",{className:"px-4 py-3 text-right",children:s.salary!=null?Number(s.salary).toLocaleString():"-"}),e.jsx("td",{className:"px-4 py-3",children:(d==null?void 0:d.userId)===s.id?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"number",className:"border rounded px-2 py-1 w-32",value:d.amount,onChange:r=>x({userId:s.id,amount:r.target.value})}),e.jsx("button",{disabled:h,onClick:()=>I(s.id,d.amount),className:"px-2 sm:px-3 py-1 rounded bg-green-600 text-white text-xs sm:text-sm whitespace-nowrap",children:"Save"}),e.jsx("button",{disabled:h,onClick:()=>x(null),className:"px-2 sm:px-3 py-1 rounded bg-gray-200 text-xs sm:text-sm whitespace-nowrap",children:"Cancel"})]}):e.jsx("button",{onClick:()=>x({userId:s.id,amount:s.salary!=null?String(s.salary):""}),className:"px-2 sm:px-3 py-1 rounded bg-amber-500 text-black text-xs sm:text-sm whitespace-nowrap",children:"Edit Salary"})})]},s.id)),!q.length&&e.jsx("tr",{children:e.jsx("td",{className:"px-4 py-6 text-gray-500",colSpan:3,children:"No manpower found."})})]})]})})]}),e.jsxs("section",{id:"drivers",className:"bg-white rounded-lg shadow overflow-hidden",children:[e.jsx("div",{className:"px-4 py-3 font-semibold border-b",children:"Drivers"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-[720px] sm:min-w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left",children:"Name"}),e.jsx("th",{className:"px-4 py-3 text-left",children:"Username"}),e.jsx("th",{className:"px-4 py-3 text-right",children:"Salary"}),e.jsx("th",{className:"px-4 py-3 text-left",children:"Action"})]})}),e.jsxs("tbody",{children:[Q.map(s=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"px-4 py-3",children:[s.first_name,s.last_name].filter(Boolean).join(" ")||"-"}),e.jsx("td",{className:"px-4 py-3",children:s.username}),e.jsx("td",{className:"px-4 py-3 text-right",children:s.salary!=null?Number(s.salary).toLocaleString():"-"}),e.jsx("td",{className:"px-4 py-3",children:(d==null?void 0:d.userId)===s.id?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"number",className:"border rounded px-2 py-1 w-32",value:d.amount,onChange:r=>x({userId:s.id,amount:r.target.value})}),e.jsx("button",{disabled:h,onClick:()=>I(s.id,d.amount),className:"px-2 sm:px-3 py-1 rounded bg-green-600 text-white text-xs sm:text-sm whitespace-nowrap",children:"Save"}),e.jsx("button",{disabled:h,onClick:()=>x(null),className:"px-2 sm:px-3 py-1 rounded bg-gray-200 text-xs sm:text-sm whitespace-nowrap",children:"Cancel"})]}):e.jsx("button",{onClick:()=>x({userId:s.id,amount:s.salary!=null?String(s.salary):""}),className:"px-2 sm:px-3 py-1 rounded bg-amber-500 text-black text-xs sm:text-sm whitespace-nowrap",children:"Edit Salary"})})]},s.id)),!Q.length&&e.jsx("tr",{children:e.jsx("td",{className:"px-4 py-6 text-gray-500",colSpan:3,children:"No drivers found."})})]})]})})]}),e.jsxs("section",{id:"vehicles",className:"bg-white rounded-lg shadow overflow-hidden",children:[e.jsx("div",{className:"px-4 py-3 font-semibold border-b",children:"Vehicles"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-[720px] sm:min-w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left",children:"Image"}),e.jsx("th",{className:"px-4 py-3 text-left",children:"Plate"}),e.jsx("th",{className:"px-4 py-3 text-left",children:"Make"}),e.jsx("th",{className:"px-4 py-3 text-left",children:"Model"}),e.jsx("th",{className:"px-4 py-3 text-left",children:"Supervisor ID"}),e.jsx("th",{className:"px-4 py-3 text-left",children:"Actions"})]})}),e.jsxs("tbody",{children:[B.map(s=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"px-4 py-3",children:s.image_url?e.jsx("button",{type:"button",onClick:()=>{ae(s.image_url),U(!0)},title:"Click to view",children:e.jsx("img",{src:s.image_url,alt:s.plate,className:"w-20 h-12 object-cover rounded border"})}):e.jsx("span",{className:"text-gray-400",children:"No image"})}),e.jsx("td",{className:"px-4 py-3",children:s.plate}),e.jsx("td",{className:"px-4 py-3",children:s.make||""}),e.jsx("td",{className:"px-4 py-3",children:s.model||""}),e.jsx("td",{className:"px-4 py-3",children:s.supervisor_id??""}),e.jsxs("td",{className:"px-4 py-3 flex flex-wrap gap-2",children:[e.jsx("button",{className:"px-2 sm:px-3 py-1 rounded bg-amber-500 text-black text-xs sm:text-sm whitespace-nowrap",onClick:()=>E(r=>({...r,[s.id]:!r[s.id]})),children:T[s.id]?"Close":"Edit Image"}),s.image_url&&e.jsx("button",{className:"px-2 sm:px-3 py-1 rounded bg-red-600 text-white hover:bg-red-700 text-xs sm:text-sm whitespace-nowrap",disabled:!!j[s.id],onClick:()=>re(s.id),children:"Delete Image"})]})]},s.id)),!B.length&&e.jsx("tr",{children:e.jsx("td",{className:"px-4 py-6 text-gray-500",colSpan:6,children:"No vehicles found."})})]})]})}),e.jsx("div",{className:"divide-y",children:B.map(s=>T[s.id]?e.jsxs("div",{className:"p-4",children:[J[s.id]&&e.jsx("div",{className:"text-red-600 mb-2 text-sm",children:J[s.id]}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-3",children:[e.jsx("input",{type:"file",accept:"image/*",onChange:r=>{var n;const a=(n=r.target.files)==null?void 0:n[0];if(!a){y(o=>({...o,[s.id]:null}));return}const t=new FileReader;t.onload=()=>y(o=>({...o,[s.id]:String(t.result||"")})),t.readAsDataURL(a)}}),e.jsx("input",{type:"url",placeholder:"Or paste image URL",value:f[s.id]??"",onChange:r=>$(a=>({...a,[s.id]:r.target.value})),className:"w-full sm:w-80 border rounded px-3 py-2"}),e.jsx("button",{className:`px-2 sm:px-3 py-1 rounded text-white ${j[s.id]?"bg-amber-400":"bg-amber-600 hover:bg-amber-700"}`,disabled:!!j[s.id],onClick:()=>te(s.id),children:j[s.id]?"Saving…":"Save Image"})]}),(V[s.id]||f[s.id])&&e.jsx("div",{className:"mt-3",children:e.jsx("img",{src:V[s.id]||f[s.id],alt:"Preview",className:"max-h-40 rounded border"})})]},`edit-${s.id}`):null)})]})]})]})};export{ce as default};
