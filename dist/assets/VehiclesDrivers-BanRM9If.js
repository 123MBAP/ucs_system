import{u as M,j as e}from"./index-B34CxXhK.js";import{r as i}from"./react-BeLGUnOF.js";const l="http://localhost:4000",F=()=>{const{t}=M(),[u,_]=i.useState([]),[S,k]=i.useState([]),[D,E]=i.useState([]),[$,v]=i.useState(!1),[b,h]=i.useState(null),[A,w]=i.useState(null),[p,x]=i.useState(""),[f,g]=i.useState(new Set);function j(){const a=localStorage.getItem("token");a&&(v(!0),h(null),Promise.all([fetch(`${l}/api/manager/drivers/with-assignments`,{headers:{Authorization:`Bearer ${a}`}}),fetch(`${l}/api/manager/vehicles`,{headers:{Authorization:`Bearer ${a}`}}),fetch(`${l}/api/manager/manpower`,{headers:{Authorization:`Bearer ${a}`}})]).then(async([s,n,N])=>{const c=await s.json(),d=await n.json(),m=await N.json();if(!s.ok)throw new Error((c==null?void 0:c.error)||"Failed to load drivers");if(!n.ok)throw new Error((d==null?void 0:d.error)||"Failed to load vehicles");if(!N.ok)throw new Error((m==null?void 0:m.error)||"Failed to load manpower");const B=(c.drivers||[]).map(r=>({id:r.id,username:r.username,vehicle_id:r.vehicle_id??null,vehicle_plate:r.vehicle_plate||null,assigned_manpowers:Array.isArray(r.assigned_manpowers)?r.assigned_manpowers.map(o=>Number(o)):[],assigned_manpower_users:Array.isArray(r.assigned_manpower_users)?r.assigned_manpower_users.map(o=>({id:Number(o.id),username:String(o.username)})):[],zones:Array.isArray(r.zones)?r.zones.map(o=>({id:Number(o.id),name:o.name})):[]}));_(B),k((d.vehicles||[]).map(r=>({id:r.id,plate:r.plate,make:r.make,model:r.model}))),E((m.manpower||[]).map(r=>({id:r.id,username:r.username})))}).catch(s=>h((s==null?void 0:s.message)||"Failed to load")).finally(()=>v(!1)))}i.useEffect(()=>{j()},[]);function C(a){w(a.id),x(a.vehicle_id!=null?String(a.vehicle_id):""),g(new Set(a.assigned_manpowers||[]))}function I(a){g(s=>{const n=new Set(s);return n.has(a)?n.delete(a):n.add(a),n})}function y(){w(null),x(""),g(new Set)}async function z(a){const s=localStorage.getItem("token");if(s)try{p===""?await fetch(`${l}/api/manager/drivers/${a}/vehicle`,{method:"DELETE",headers:{Authorization:`Bearer ${s}`}}):await fetch(`${l}/api/manager/drivers/${a}/vehicle`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({vehicleId:Number(p)})}),await fetch(`${l}/api/manager/drivers/${a}/vehicle/manpowers`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({manpowerIds:Array.from(f)})}),y(),j()}catch(n){h((n==null?void 0:n.message)||"Failed to save assignments")}}return e.jsxs("div",{className:"p-6 bg-gradient-to-br from-gray-50 to-amber-50 min-h-screen",children:[e.jsx("h2",{className:"text-2xl font-bold mb-4 bg-gradient-to-r from-amber-600 to-amber-500 bg-clip-text text-transparent",children:t("vehDrv.title")}),b&&e.jsx("div",{className:"text-red-700 bg-red-50 border border-red-200 rounded-xl px-3 py-2 mb-3",children:b}),$?e.jsx("div",{className:"text-gray-600",children:t("vehDrv.loading")}):e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[u.map(a=>e.jsxs("div",{className:"bg-white rounded-2xl shadow-md p-4 border border-amber-100",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:a.username}),e.jsx("span",{className:"text-sm text-amber-700"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{children:[e.jsxs("span",{className:"text-gray-600 text-sm",children:[t("vehDrv.assignedCar"),":"]}),e.jsx("span",{className:"ml-2 font-medium text-gray-900",children:a.vehicle_plate||t("vehDrv.notSet")})]}),e.jsxs("div",{children:[e.jsxs("span",{className:"text-gray-600 text-sm",children:[t("vehDrv.assignedManpowers"),":"]}),e.jsx("span",{className:"ml-2 font-medium text-gray-900",children:a.assigned_manpower_users&&a.assigned_manpower_users.length?a.assigned_manpower_users.map(s=>s.username).join(", "):t("vehDrv.none")})]}),e.jsx("div",{})]}),A===a.id?e.jsxs("div",{className:"mt-3 border-t pt-3 space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-800",children:t("vehDrv.assignVehicle")}),e.jsxs("select",{value:p,onChange:s=>x(s.target.value),className:"mt-1 w-full border rounded px-2 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-400",children:[e.jsx("option",{value:"",children:t("vehDrv.noneOption")}),S.map(s=>e.jsxs("option",{value:s.id,children:[s.plate,s.make||s.model?` (${[s.make,s.model].filter(Boolean).join(" ")})`:""]},s.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-800 mb-1",children:t("vehDrv.assignManpowersToVehicle")}),e.jsx("div",{className:"max-h-40 overflow-auto border rounded p-2 space-y-1 bg-amber-50/40",children:D.map(s=>e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:f.has(s.id),onChange:()=>I(s.id)}),e.jsx("span",{children:s.username})]},s.id))})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>z(a.id),className:"px-3 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded text-sm transition-colors",children:t("vehDrv.save")}),e.jsx("button",{onClick:y,className:"px-3 py-2 border border-amber-200 hover:border-amber-300 text-amber-800 rounded text-sm transition-colors bg-amber-50",children:t("vehDrv.cancel")})]})]}):e.jsx("div",{className:"mt-3",children:e.jsx("button",{onClick:()=>C(a),className:"text-amber-700 hover:text-amber-800 underline text-sm",children:t("vehDrv.manageManpowers")})})]},a.id)),!u.length&&e.jsx("div",{className:"text-gray-600",children:t("vehDrv.noDrivers")})]})]})};export{F as default};
