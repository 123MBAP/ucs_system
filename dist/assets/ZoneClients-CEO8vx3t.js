import{j as e}from"./index-DZTFkylD.js";import{g as G,f as K,r as l,L as Q}from"./react-CzDbI3ao.js";const x="http://localhost:4000",X=()=>{const{id:m}=G(),L=K(),[v,_]=l.useState(null),[f,B]=l.useState([]),[T,Z]=l.useState([]),[M,k]=l.useState(!1),[S,h]=l.useState(null),[p,b]=l.useState(""),[u,j]=l.useState(!1),[i,d]=l.useState([]),[y,N]=l.useState(null),[C,E]=l.useState(""),[$,z]=l.useState(""),[A,F]=l.useState(""),[w,P]=l.useState("");function g(){const t=localStorage.getItem("token");!t||!m||(k(!0),h(null),Promise.all([fetch(`${x}/api/zones/${m}`,{headers:{Authorization:`Bearer ${t}`}}),fetch(`${x}/api/clients/by-zone/${m}`,{headers:{Authorization:`Bearer ${t}`}}),fetch(`${x}/api/zones`,{headers:{Authorization:`Bearer ${t}`}})]).then(async([s,n,r])=>{const a=await s.json(),o=await n.json(),c=await r.json();if(!s.ok)throw new Error((a==null?void 0:a.error)||"Failed to load zone");if(!n.ok)throw new Error((o==null?void 0:o.error)||"Failed to load clients");if(!r.ok)throw new Error((c==null?void 0:c.error)||"Failed to load zones");_({id:a.zone.id,zone_name:a.zone.zone_name}),B(Array.isArray(o.clients)?o.clients:[]),Z((c.zones||[]).map(I=>({id:String(I.id),name:I.zone_name})))}).catch(s=>h((s==null?void 0:s.message)||"Failed to load")).finally(()=>k(!1)))}function U(){var n,r;if(i.length!==1)return;const t=i[0],s=f.find(a=>a.id===t);s&&(N(t),E(((n=s.name)==null?void 0:n.first)||""),z(((r=s.name)==null?void 0:r.last)||""),F(s.username||""),P(s.monthly_amount!=null?String(Number(s.monthly_amount).toFixed(2)).replace(/\.00$/,""):""))}function D(){N(null)}function H(){if(!y)return;const t=localStorage.getItem("token");if(!t)return;const s={username:A.trim()||void 0,firstName:C.trim(),lastName:$.trim()};w!==""&&(s.monthlyAmount=Number(w)),fetch(`${x}/api/clients/${y}`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(s)}).then(async n=>{const r=await n.json();if(!n.ok)throw new Error((r==null?void 0:r.error)||"Failed to update client");N(null),d([]),g()}).catch(n=>h((n==null?void 0:n.message)||"Failed to update client"))}l.useEffect(()=>{g()},[m]);function J(){j(t=>!t),d([])}function O(t){d(s=>s.includes(t)?s.filter(n=>n!==t):[...s,t])}function R(){const t=localStorage.getItem("token");!t||!p||!i.length||Promise.all(i.map(s=>fetch(`${x}/api/clients/${s}/zone`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({zoneId:Number(p)})}))).then(async s=>{const r=(await Promise.all(s.map(async a=>{var o;return a.ok?null:((o=await a.json())==null?void 0:o.error)||"error"}))).find(a=>a);if(r)throw new Error(r);d([]),b(""),g()}).catch(s=>h((s==null?void 0:s.message)||"Failed to move selected"))}function q(){const t=localStorage.getItem("token");!t||!i.length||!window.confirm(`Delete ${i.length} selected client(s)? This cannot be undone.`)||Promise.all(i.map(n=>fetch(`${x}/api/clients/${n}`,{method:"DELETE",headers:{Authorization:`Bearer ${t}`}}))).then(async n=>{const a=(await Promise.all(n.map(async o=>{var c;return o.ok?null:((c=await o.json())==null?void 0:c.error)||"error"}))).find(o=>o);if(a)throw new Error(a);d([]),g()}).catch(n=>h((n==null?void 0:n.message)||"Failed to delete selected"))}return e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("button",{onClick:()=>L(-1),className:"text-blue-600 underline text-sm",children:"← Back"}),m&&e.jsx(Q,{to:`/register-client?zoneId=${m}`,className:"text-blue-600 underline text-sm",children:"Add Client"})]}),e.jsxs("h2",{className:"text-2xl font-bold mb-4",children:["Clients in ",v?v.zone_name:"Zone"]}),S&&e.jsx("div",{className:"text-red-600 mb-3",children:S}),M?e.jsx("div",{children:"Loading…"}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-3 flex items-center justify-between",children:[e.jsx("button",{onClick:J,className:"px-3 py-1 border rounded text-sm",children:u?"Cancel select":"Select"}),u&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{value:p,onChange:t=>b(t.target.value),className:"border rounded px-2 py-1 text-sm",children:[e.jsx("option",{value:"",children:"-- Move to zone --"}),T.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsx("button",{disabled:!i.length||!p,onClick:R,className:"px-3 py-1 bg-blue-600 text-white rounded text-sm disabled:opacity-50",children:"Move"}),e.jsx("button",{disabled:!i.length,onClick:q,className:"px-3 py-1 bg-red-600 text-white rounded text-sm disabled:opacity-50",children:"Delete"}),e.jsx("span",{className:"mx-2 text-gray-300",children:"|"}),e.jsx("button",{onClick:()=>{j(!1),d([])},className:"px-3 py-1 border rounded text-sm",children:"Save"}),e.jsx("button",{onClick:()=>{j(!1),d([]),b("")},className:"px-3 py-1 border rounded text-sm",children:"Cancel"})]})]}),e.jsx("div",{className:"overflow-x-auto bg-white border rounded shadow",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[u&&e.jsx("th",{className:"px-3 py-2"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Name"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Username"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Phone Number"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Amount to Pay"})]})}),e.jsxs("tbody",{className:"bg-white divide-y divide-gray-200",children:[f.map(t=>{const s=t.name?`${t.name.first||""} ${t.name.last||""}`.trim():"";return e.jsxs("tr",{children:[u&&e.jsx("td",{className:"px-3 py-2",children:e.jsx("input",{type:"checkbox",checked:i.includes(t.id),onChange:()=>O(t.id)})}),e.jsx("td",{className:"px-3 py-2",children:s||t.username}),e.jsx("td",{className:"px-3 py-2",children:t.username}),e.jsx("td",{className:"px-3 py-2",children:t.phone_number}),e.jsx("td",{className:"px-3 py-2",children:t.monthly_amount!=null?Number(t.monthly_amount).toLocaleString():"-"})]},t.id)}),!f.length&&e.jsx("tr",{children:e.jsx("td",{className:"px-3 py-4 text-gray-600",colSpan:u?5:4,children:"No clients in this zone."})})]})]})}),u&&i.length===1&&e.jsxs("div",{className:"mt-4 p-4 border rounded bg-white shadow",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("div",{className:"font-semibold",children:"Edit selected client"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{onClick:U,className:"px-3 py-1 border rounded text-sm",children:"Edit"})})]}),y&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700",children:"First Name"}),e.jsx("input",{className:"mt-1 w-full border rounded px-2 py-1",value:C,onChange:t=>E(t.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700",children:"Last Name"}),e.jsx("input",{className:"mt-1 w-full border rounded px-2 py-1",value:$,onChange:t=>z(t.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700",children:"Username"}),e.jsx("input",{className:"mt-1 w-full border rounded px-2 py-1",value:A,onChange:t=>F(t.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700",children:"Amount to Pay"}),e.jsx("input",{type:"number",step:"0.01",className:"mt-1 w-full border rounded px-2 py-1",value:w,onChange:t=>P(t.target.value)})]}),e.jsxs("div",{className:"md:col-span-4 flex items-center gap-2 mt-2",children:[e.jsx("button",{onClick:H,className:"px-3 py-1 bg-blue-600 text-white rounded text-sm",children:"Save"}),e.jsx("button",{onClick:D,className:"px-3 py-1 border rounded text-sm",children:"Cancel"})]})]})]})]})]})};export{X as default};
