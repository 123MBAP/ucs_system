import{j as e}from"./index-DaGMaRVu.js";import{r as i}from"./react-CzDbI3ao.js";const c="http://localhost:4000",U=()=>{const[x,k]=i.useState(""),[p,C]=i.useState(""),[f,$]=i.useState(""),[v,A]=i.useState(!1),[d,w]=i.useState("existing"),[J,L]=i.useState([]),[j,E]=i.useState(null),[b,V]=i.useState(""),[N,F]=i.useState([]),[Z,q]=i.useState([]),[y,h]=i.useState(!1),[P,T]=i.useState(null),[z,m]=i.useState(null);function I(s){F(a=>a.includes(s)?a.filter(t=>t!==s):[...a,s])}i.useEffect(()=>{const s=localStorage.getItem("token");s&&(fetch(`${c}/api/zones`,{headers:{Authorization:`Bearer ${s}`}}).then(async a=>{const t=await a.json();if(!a.ok)throw new Error((t==null?void 0:t.error)||"Failed to load zones");const o=(t.zones||[]).map(n=>({id:String(n.id),name:n.zone_name}));q(o)}).catch(a=>console.error("Load zones error:",a)),fetch(`${c}/api/manager/vehicles`,{headers:{Authorization:`Bearer ${s}`}}).then(async a=>{const t=await a.json();if(!a.ok)throw new Error((t==null?void 0:t.error)||"Failed to load vehicles");const o=(t.vehicles||[]).map(n=>({id:String(n.id),plate:n.plate}));L(o)}).catch(a=>console.error("Load vehicles error:",a)))},[]);function M(s){if(s.preventDefault(),m(null),T(null),h(!0),!x.trim()||!p.trim()||!f.trim()){m("First name, last name and username/email are required."),h(!1);return}const a={firstName:x,lastName:p,username:f},t=localStorage.getItem("token");if(!t){m("You must be logged in as manager to create a driver."),h(!1);return}fetch(`${c}/api/manager/drivers`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(a)}).then(async o=>{var B,O;const n=await o.json();if(!o.ok)throw new Error((n==null?void 0:n.error)||"Failed to create driver");const u=(B=n==null?void 0:n.driver)==null?void 0:B.id;if(!u)throw new Error("Driver created but id missing");if(v)if(d==="existing"){if(!j)throw new Error("Please select a vehicle to assign.");const l=await fetch(`${c}/api/manager/drivers/${u}/vehicle`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({vehicleId:Number(j)})}),r=await l.json();if(!l.ok)throw new Error((r==null?void 0:r.error)||"Failed to assign vehicle")}else{if(!b.trim())throw new Error("Please provide the new vehicle plate");const l=await fetch(`${c}/api/manager/vehicles`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({plate:b.trim()})}),r=await l.json();if(!l.ok)throw new Error((r==null?void 0:r.error)||"Failed to create vehicle");const g=(O=r==null?void 0:r.vehicle)==null?void 0:O.id;if(!g)throw new Error("Vehicle created but id missing");const D=await fetch(`${c}/api/manager/drivers/${u}/vehicle`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({vehicleId:g})}),S=await D.json();if(!D.ok)throw new Error((S==null?void 0:S.error)||"Failed to assign new vehicle")}if(N.length){const l=await fetch(`${c}/api/manager/drivers/${u}/zones`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({zoneIds:N.map(g=>Number(g))})}),r=await l.json();if(!l.ok)throw new Error((r==null?void 0:r.error)||"Failed to set driver zones")}T(`Driver created. Temporary password: ${n.tempPassword}`),k(""),C(""),$(""),A(!1),w("existing"),E(null),V(""),F([])}).catch(o=>m(o.message||"Failed to create driver")).finally(()=>h(!1))}return e.jsxs("div",{className:"p-6 max-w-2xl",children:[e.jsx("h2",{className:"text-2xl font-bold mb-4",children:"Register Driver"}),e.jsxs("form",{onSubmit:M,className:"space-y-4",children:[z&&e.jsx("div",{className:"text-red-600",children:z}),P&&e.jsx("div",{className:"text-green-600",children:P}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"First Name"}),e.jsx("input",{className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm",value:x,onChange:s=>k(s.target.value),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Last Name"}),e.jsx("input",{className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm",value:p,onChange:s=>C(s.target.value),required:!0})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Username or Email"}),e.jsx("input",{className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm",value:f,onChange:s=>$(s.target.value),required:!0})]}),e.jsx("div",{className:"pt-2",children:e.jsxs("label",{className:"inline-flex items-center",children:[e.jsx("input",{type:"checkbox",checked:v,onChange:s=>A(s.target.checked),className:"mr-2"}),e.jsx("span",{children:"Assign Vehicle (optional)"})]})}),v&&e.jsxs("div",{className:"p-4 border rounded-md",children:[e.jsxs("div",{className:"space-x-4 mb-3",children:[e.jsxs("label",{className:"inline-flex items-center",children:[e.jsx("input",{type:"radio",name:"vehicleMode",value:"existing",checked:d==="existing",onChange:()=>w("existing"),className:"mr-2"}),e.jsx("span",{children:"Assign existing vehicle"})]}),e.jsxs("label",{className:"inline-flex items-center ml-4",children:[e.jsx("input",{type:"radio",name:"vehicleMode",value:"new",checked:d==="new",onChange:()=>w("new"),className:"mr-2"}),e.jsx("span",{children:"Assign new vehicle"})]})]}),d==="existing"?e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Select Vehicle"}),e.jsxs("select",{value:j??"",onChange:s=>E(s.target.value||null),className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm",children:[e.jsx("option",{value:"",children:"-- Select vehicle --"}),J.map(s=>e.jsx("option",{value:s.id,children:s.plate},s.id))]})]}):e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"New Vehicle Plate"}),e.jsx("input",{className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm",value:b,onChange:s=>V(s.target.value)})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Assign Zones (optional)"}),e.jsx("div",{className:"mt-2 space-y-2",children:Z.map(s=>e.jsxs("label",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",checked:N.includes(s.id),onChange:()=>I(s.id)}),e.jsx("span",{children:s.name})]},s.id))})]}),e.jsx("div",{children:e.jsx("button",{type:"submit",disabled:y,className:`px-4 py-2 text-white rounded-md ${y?"bg-blue-400":"bg-blue-600 hover:bg-blue-700"}`,children:y?"Creatingâ€¦":"Create Driver"})})]})]})};export{U as default};
