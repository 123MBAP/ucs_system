import{j as t}from"./index-CdjKjvMW.js";import{R as n}from"./react-CzDbI3ao.js";function U(){var $,S;const u=((S=($=import.meta)==null?void 0:$.env)==null?void 0:S.VITE_API_BASE)||"",[l,g]=n.useState("general"),[p,f]=n.useState(""),[A,E]=n.useState([]),[i,d]=n.useState(null),[m,w]=n.useState(!1),[c,v]=n.useState(null);let x=null,b=null;try{const e=localStorage.getItem("user"),s=e?JSON.parse(e):null;x=(s==null?void 0:s.role)??null,b=(s==null?void 0:s.id)??null}catch{}const R=x!=="client",I=x==="client",j=n.useRef({}),y=e=>{const s=j.current[e];s&&(s.scrollIntoView({behavior:"smooth",block:"center"}),s.classList.add("ring-2","ring-amber-400"),setTimeout(()=>s.classList.remove("ring-2","ring-amber-400"),1e3))};async function N(e){try{w(!0),v(null);const s=localStorage.getItem("token"),r=await fetch(`${u}/api/chat/messages?group=${encodeURIComponent(e)}&limit=100`,{headers:{Accept:"application/json",Authorization:s?`Bearer ${s}`:""}});if(!r.ok){const o=await r.json().catch(()=>({}));throw new Error((o==null?void 0:o.error)||`Failed to load messages (${r.status})`)}const a=await r.json(),h=Array.isArray(a==null?void 0:a.messages)?[...a.messages].reverse():[];E(h)}catch(s){v(String((s==null?void 0:s.message)||s))}finally{w(!1)}}n.useEffect(()=>{N(l)},[l]);async function _(){const e=p.trim();if(e)try{const s=localStorage.getItem("token"),r=await fetch(`${u}/api/chat/messages`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:s?`Bearer ${s}`:""},body:JSON.stringify({group:l,message:e,reply_to_id:(i==null?void 0:i.id)??null})});if(!r.ok){const a=await r.json().catch(()=>({}));throw new Error((a==null?void 0:a.error)||`Failed to send message (${r.status})`)}f(""),d(null),await N(l)}catch(s){alert(String((s==null?void 0:s.message)||s))}}const k=A.filter(e=>e.group===l);return t.jsxs("div",{className:"p-4 sm:p-6",children:[t.jsxs("div",{className:"max-w-5xl mx-auto bg-white/95 backdrop-blur rounded-2xl shadow-xl border border-amber-200 overflow-hidden",children:[t.jsx("div",{className:"px-4 py-3 border-b border-amber-200 bg-gradient-to-r from-amber-600 to-amber-500 text-white",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("div",{className:"text-sm opacity-90",children:l==="general"?"All Users Group":"Workers Group"}),t.jsx("div",{className:"text-xs opacity-90",children:l==="general"?"Community chat for all users":"Chat for workers (hidden from clients)"})]}),!I&&t.jsx("div",{className:"bg-white/15 border border-white/20 rounded-xl p-1",children:t.jsxs("div",{className:"flex text-xs",children:[t.jsx("button",{className:`${l==="general"?"bg-white text-amber-700":"text-white/90"} px-3 py-1 rounded-lg transition`,onClick:()=>g("general"),children:"All Users"}),R&&t.jsx("button",{className:`${l==="workers"?"bg-white text-amber-700":"text-white/90"} px-3 py-1 rounded-lg transition`,onClick:()=>g("workers"),children:"Workers"})]})})]})}),t.jsxs("div",{className:"h-[68vh] flex flex-col",children:[t.jsxs("div",{className:"flex-1 overflow-y-auto p-4 sm:p-6 space-y-4 bg-gradient-to-b from-white to-amber-50/40",children:[m&&t.jsx("div",{className:"text-center text-amber-800/70 text-sm",children:"Loading…"}),c&&t.jsx("div",{className:"text-center text-red-600 text-sm",children:c}),!m&&!c&&k.length===0&&t.jsx("div",{className:"text-center text-amber-800/70 text-sm",children:"No messages yet."}),!m&&!c&&k.map(e=>{const s=b!=null&&e.user_id===b,r=s?"You":e.client_name&&(e.client_name.first||e.client_name.last)?`${e.client_name.first??""} ${e.client_name.last??""}`.trim():e.client_username||e.user_username||"User",a=e.client_avatar||"",h=(e.message||"").slice(0,80),o=e.reply_client_name&&(e.reply_client_name.first||e.reply_client_name.last)?`${e.reply_client_name.first??""} ${e.reply_client_name.last??""}`.trim():e.reply_client_username||e.reply_user_username||null,C=e.reply_message;return t.jsx("div",{className:`w-full flex ${s?"justify-end":"justify-start"}`,children:t.jsxs("div",{className:`flex items-end gap-2 ${s?"flex-row-reverse":""}`,children:[!s&&t.jsx("div",{className:"w-8 h-8 rounded-full overflow-hidden ring-2 ring-amber-200 bg-amber-50 flex items-center justify-center text-[11px] text-amber-700 font-semibold",children:a?t.jsx("img",{src:a,alt:r,className:"w-full h-full object-cover"}):(r==null?void 0:r[0])||"U"}),t.jsxs("div",{ref:M=>{j.current[e.id]=M},className:`group relative max-w-[78%] px-4 py-2.5 rounded-2xl border shadow-sm transition ${s?"bg-amber-600 text-white border-amber-500":"bg-white text-amber-900 border-amber-200 hover:border-amber-300"}`,children:[t.jsxs("div",{className:"flex items-center justify-between gap-3 mb-1",children:[t.jsx("div",{className:`text-[12px] font-semibold ${s?"text-white":"text-amber-800"}`,children:r}),t.jsx("div",{className:`text-[11px] ${s?"text-white/80":"text-amber-700/70"}`,children:new Date(e.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]}),t.jsx("button",{title:"Reply",onClick:()=>d({id:e.id,name:r,snippet:h}),className:`hidden group-hover:flex absolute ${s?"left-2":"right-2"} -top-3 items-center justify-center w-6 h-6 rounded-full shadow bg-white text-amber-700 border border-amber-200`,children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",className:"w-4 h-4",children:t.jsx("path",{d:"M10 8.5V6l-6 6 6 6v-2.5l4-.5a6 6 0 004.5-3.5l.5-1-1 .2A17 17 0 0010 8.5z"})})}),C&&t.jsxs("div",{className:`mb-2 rounded-xl border ${s?"border-white/30 bg-white/10":"border-amber-200 bg-amber-50"}`,children:[t.jsx("div",{className:`text-[12px] font-semibold px-3 pt-2 ${s?"text-white":"text-amber-800"} cursor-pointer`,onClick:()=>e.reply_id&&y(e.reply_id),children:o||"Replied message"}),t.jsx("div",{className:`text-xs px-3 pb-2 ${s?"text-white/85":"text-amber-800/80"} cursor-pointer`,onClick:()=>e.reply_id&&y(e.reply_id),children:C})]}),t.jsx("div",{className:"text-sm leading-relaxed whitespace-pre-wrap break-words",children:e.message})]})]})},e.id)})]}),t.jsxs("div",{className:"border-t border-amber-200 bg-white/90 p-3 space-y-2",children:[i&&t.jsxs("div",{className:"flex items-start justify-between gap-3 p-2 rounded-lg border border-amber-200 bg-amber-50",children:[t.jsxs("div",{children:[t.jsxs("div",{className:"text-xs font-semibold text-amber-800",children:["Replying to ",i.name]}),t.jsx("div",{className:"text-xs text-amber-700/80 line-clamp-2",children:i.snippet})]}),t.jsx("button",{onClick:()=>d(null),className:"text-amber-700/70 hover:text-amber-800 text-xs font-medium",children:"Cancel"})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("input",{value:p,onChange:e=>f(e.target.value),onKeyDown:e=>{e.key==="Enter"&&_()},className:"flex-1 px-4 py-2.5 rounded-xl border border-amber-200 focus:outline-none focus:ring-2 focus:ring-amber-500 bg-white text-amber-900 placeholder-amber-700/50",placeholder:l==="general"?"Message everyone…":"Message workers…"}),t.jsx("button",{onClick:_,className:"px-4 py-2.5 rounded-xl bg-gradient-to-r from-amber-600 to-amber-500 text-white font-medium hover:from-amber-700 hover:to-amber-600 shadow-sm",children:"Send"})]})]})]})]}),t.jsx("style",{children:`
        .text-charcoal {
          color: #1E1E1E;
        }
        .bg-amber-600 {
          background-color: #D97706;
        }
        .bg-amber-700 {
          background-color: #B45309;
        }
        .bg-green-600 {
          background-color: #15803D;
        }
        .bg-green-100 {
          background-color: #DCFCE7;
        }
      `})]})}export{U as default};
