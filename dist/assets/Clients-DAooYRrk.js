import{j as e}from"./index-DaGMaRVu.js";import{f as D,u as O,r as i,L as $}from"./react-CzDbI3ao.js";const x="http://localhost:4000",G=()=>{const g=D(),C=O(),[o,_]=i.useState(null),[y,A]=i.useState([]),[j,z]=i.useState([]),[N,I]=i.useState({}),[c,L]=i.useState(null),[E,m]=i.useState(!1),[v,b]=i.useState(null),[u,F]=i.useState(""),[P,B]=i.useState([]),[p,M]=i.useState(""),[d,w]=i.useState(new Set),[f,R]=i.useState("");i.useEffect(()=>{const t=localStorage.getItem("token");t&&fetch(`${x}/api/me`,{headers:{Authorization:`Bearer ${t}`}}).then(async a=>{var n;const s=await a.json();if(!a.ok)throw new Error((s==null?void 0:s.error)||"Failed to load user");_(((n=s==null?void 0:s.user)==null?void 0:n.role)??null)}).catch(()=>{})},[]),i.useEffect(()=>{const t=localStorage.getItem("token");!t||o!=="manager"||fetch(`${x}/api/report/supervisors`,{headers:{Authorization:`Bearer ${t}`}}).then(async a=>{const s=await a.json();if(!a.ok)throw new Error((s==null?void 0:s.error)||"Failed to load supervisors");B(Array.isArray(s.supervisors)?s.supervisors:[])}).catch(()=>{})},[o]),i.useEffect(()=>{const t=localStorage.getItem("token");if(!t)return;if(m(!0),b(null),o==="chief"){fetch(`${x}/api/chief/clients`,{headers:{Authorization:`Bearer ${t}`}}).then(async s=>{const n=await s.json();if(!s.ok)throw new Error((n==null?void 0:n.error)||"Failed to load clients");z(Array.isArray(n.clients)?n.clients:[])}).catch(s=>b((s==null?void 0:s.message)||"Failed to load")).finally(()=>m(!1));return}fetch(`${x}/api/zones${o==="supervisor"?"?scope=supervisor":""}`,{headers:{Authorization:`Bearer ${t}`}}).then(async s=>{const n=await s.json();if(!s.ok)throw new Error((n==null?void 0:n.error)||"Failed to load zones");let r=(n.zones||[]).map(l=>({id:l.id,zone_name:l.zone_name,cell:l.cell,village:l.village,chief_username:l.chief_username??null,client_count:Number(l.client_count||0)}));return o==="manager"&&p&&(r=(n.zones||[]).filter(l=>String(l.supervisor_id||"")===p).map(l=>({id:l.id,zone_name:l.zone_name,cell:l.cell,village:l.village,chief_username:l.chief_username??null,client_count:Number(l.client_count||0)}))),A(r),r}).then(async s=>{const n=localStorage.getItem("token");if(!n)return;const r={};for(const l of s)try{const h=await fetch(`${x}/api/clients/by-zone/${l.id}`,{headers:{Authorization:`Bearer ${n}`}}),S=await h.json();h.ok&&(r[l.id]=Array.isArray(S.clients)?S.clients:[])}catch{}I(r)}).catch(s=>b((s==null?void 0:s.message)||"Failed to load")).finally(()=>m(!1))},[C.search,o,p]);const k=i.useMemo(()=>{const t=u.toLowerCase().trim();return t?j.filter(a=>{var s,n;return(a.username||"").toLowerCase().includes(t)||(a.phone_number||"").toLowerCase().includes(t)||`${((s=a.name)==null?void 0:s.first)||""} ${((n=a.name)==null?void 0:n.last)||""}`.trim().toLowerCase().includes(t)}):j},[j,u]),Z=i.useMemo(()=>{const t=u.toLowerCase().trim();if(!t)return N;const a={};for(const[s,n]of Object.entries(N))a[Number(s)]=n.filter(r=>{var l,h;return(r.username||"").toLowerCase().includes(t)||(r.phone_number||"").toLowerCase().includes(t)||`${((l=r.name)==null?void 0:l.first)||""} ${((h=r.name)==null?void 0:h.last)||""}`.trim().toLowerCase().includes(t)});return a},[N,u]);function U(t){w(a=>{const s=new Set(a);return s.has(t)?s.delete(t):s.add(t),s})}async function T(){const t=localStorage.getItem("token");if(!(!t||!d.size)&&confirm(`Delete ${d.size} client(s)?`)){m(!0);try{await Promise.all(Array.from(d).map(async a=>{await fetch(`${x}/api/clients/${a}`,{method:"DELETE",headers:{Authorization:`Bearer ${t}`}})})),w(new Set),g(0)}finally{m(!1)}}}async function q(){const t=localStorage.getItem("token"),a=Number(f);if(!(!t||!d.size||!Number.isFinite(a))){m(!0);try{await Promise.all(Array.from(d).map(async s=>{await fetch(`${x}/api/clients/${s}/zone`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({zoneId:a})})})),w(new Set),g(0)}finally{m(!1)}}}return e.jsxs("div",{className:"p-6",children:[e.jsx("div",{className:"mb-2",children:e.jsx("button",{onClick:()=>g(-1),className:"text-blue-600 underline text-sm",children:"← Back"})}),e.jsx("h2",{className:"text-2xl font-bold mb-4",children:"Clients"}),e.jsxs("div",{className:"mb-4 flex flex-wrap items-end gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700",children:"Search"}),e.jsx("input",{value:u,onChange:t=>F(t.target.value),className:"mt-1 border rounded px-3 py-2",placeholder:"Search by name, username or phone"})]}),o==="manager"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700",children:"Supervisor"}),e.jsxs("select",{className:"mt-1 border rounded px-2 py-2",value:p,onChange:t=>M(t.target.value),children:[e.jsx("option",{value:"",children:"All Supervisors"}),P.map(t=>e.jsx("option",{value:t.id,children:t.username},t.id))]})]})]}),v&&e.jsx("div",{className:"text-red-600 mb-3",children:v}),E?e.jsx("div",{children:"Loading…"}):e.jsxs(e.Fragment,{children:[o==="chief"?e.jsx("div",{className:"overflow-x-auto bg-white border rounded shadow",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Photo"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Name"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Username"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Phone"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Amount"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsxs("tbody",{className:"bg-white divide-y divide-gray-200",children:[k.map(t=>{const a=t.name?`${t.name.first||""} ${t.name.last||""}`.trim():"";return e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2",children:t.profile_image_url?e.jsx("img",{src:t.profile_image_url,alt:"",className:"w-8 h-8 rounded-full object-cover"}):e.jsx("div",{className:"w-8 h-8 rounded-full bg-gray-200"})}),e.jsx("td",{className:"px-3 py-2",children:a||t.username}),e.jsx("td",{className:"px-3 py-2",children:t.username}),e.jsx("td",{className:"px-3 py-2",children:t.phone_number}),e.jsx("td",{className:"px-3 py-2",children:t.monthly_amount!=null?Number(t.monthly_amount).toLocaleString():"-"}),e.jsx("td",{className:"px-3 py-2",children:e.jsx($,{to:`/payments?scope=chief&clientId=${encodeURIComponent(String(t.id))}&clientName=${encodeURIComponent((t.name?`${t.name.first||""} ${t.name.last||""}`.trim():"")||t.username)}`,className:"px-2 py-1 text-sm bg-amber-500 text-black rounded",children:"Pay"})})]},t.id)}),!k.length&&e.jsx("tr",{children:e.jsx("td",{className:"px-3 py-4 text-gray-600",colSpan:5,children:"No clients."})})]})]})}):e.jsxs("div",{className:"overflow-x-auto bg-white border rounded shadow",children:[e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-10",children:"Sel"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Photo"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Name"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Username"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Phone"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Amount"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Zone"})]})}),e.jsxs("tbody",{className:"bg-white divide-y divide-gray-200",children:[y.flatMap(t=>{const a=Z[t.id]||[],s=e.jsx("tr",{className:"bg-gray-50",children:e.jsx("td",{className:"px-3 py-2 text-gray-600",colSpan:6,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"font-semibold",children:[t.zone_name," ",e.jsxs("span",{className:"text-xs text-gray-500",children:["(#",t.id,")"]})]}),e.jsxs("div",{className:"text-sm text-gray-600",children:["Clients: ",a.length]})]})})},`zone-${t.id}`),n=a.map(r=>{const l=r.name?`${r.name.first||""} ${r.name.last||""}`.trim():"";return e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2",children:e.jsx("input",{type:"checkbox",checked:d.has(r.id),onChange:()=>U(r.id)})}),e.jsx("td",{className:"px-3 py-2",children:r.profile_image_url?e.jsx("img",{src:r.profile_image_url,alt:"",className:"w-8 h-8 rounded-full object-cover"}):e.jsx("div",{className:"w-8 h-8 rounded-full bg-gray-200"})}),e.jsx("td",{className:"px-3 py-2",children:l||r.username}),e.jsx("td",{className:"px-3 py-2",children:r.username}),e.jsx("td",{className:"px-3 py-2",children:r.phone_number}),e.jsx("td",{className:"px-3 py-2",children:r.monthly_amount!=null?Number(r.monthly_amount).toLocaleString():"-"}),e.jsx("td",{className:"px-3 py-2",children:t.zone_name})]},r.id)});return[s,...n]}),!y.length&&e.jsx("tr",{children:e.jsx("td",{className:"px-3 py-4 text-gray-600",colSpan:6,children:"No zones."})})]})]}),(o==="manager"||o==="supervisor")&&e.jsxs("div",{className:"p-3 border-t flex items-center gap-3",children:[e.jsx("button",{disabled:!d.size,onClick:T,className:`px-3 py-2 rounded text-white ${d.size?"bg-red-600":"bg-gray-300 cursor-not-allowed"}`,children:"Delete Selected"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{className:"border rounded px-2 py-2",value:f,onChange:t=>R(t.target.value),children:[e.jsx("option",{value:"",children:"Move to zone…"}),y.map(t=>e.jsx("option",{value:t.id,children:t.zone_name},t.id))]}),e.jsx("button",{disabled:!d.size||!f,onClick:q,className:`px-3 py-2 rounded text-white ${d.size&&f?"bg-blue-600":"bg-gray-300 cursor-not-allowed"}`,children:"Move Selected"})]})]})]}),c&&o==="chief"&&e.jsxs("div",{className:"mt-4 bg-white border rounded shadow p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Make Payment"}),e.jsxs("p",{className:"text-sm text-gray-600 mt-1",children:["For client: ",e.jsx("span",{className:"font-medium",children:(c.name?`${c.name.first||""} ${c.name.last||""}`.trim():"")||c.username})]})]}),e.jsx("button",{onClick:()=>L(null),className:"text-sm text-gray-600 hover:text-gray-800",children:"Clear"})]}),e.jsx("div",{className:"mt-3",children:e.jsx($,{to:`/payments?scope=chief&clientId=${encodeURIComponent(String(c.id))}&clientName=${encodeURIComponent((c.name?`${c.name.first||""} ${c.name.last||""}`.trim():"")||c.username)}`,className:"inline-flex items-center px-4 py-2 rounded font-semibold text-black",style:{backgroundColor:"#FFCB05"},children:"Proceed to Payment"})})]})]})]})};export{G as default};
