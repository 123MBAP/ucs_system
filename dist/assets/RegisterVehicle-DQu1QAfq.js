import{j as e}from"./index-B9Qtw13a.js";import{f as H,r as a}from"./react-BeLGUnOF.js";const o="http://localhost:4000",G=()=>{const R=H(),[x,S]=a.useState(""),[k,C]=a.useState(""),[D,$]=a.useState(""),[d,A]=a.useState(!1),[m,v]=a.useState("existing"),[V,J]=a.useState([]),[p,E]=a.useState(""),[f,F]=a.useState(""),[j,I]=a.useState(""),[b,T]=a.useState(!1),[O,h]=a.useState(null),[P,U]=a.useState(null),[u,w]=a.useState(null),[g,N]=a.useState("");a.useEffect(()=>{const s=localStorage.getItem("token");s&&fetch(`${o}/api/manager/users?role=driver`,{headers:{Authorization:`Bearer ${s}`}}).then(async i=>{const l=await i.json();if(!i.ok)throw new Error((l==null?void 0:l.error)||"Failed to load drivers");J((l.users||[]).map(r=>({id:String(r.id),username:r.username})))}).catch(()=>{})},[]);async function q(s){var l;if(s.preventDefault(),h(null),U(null),!x.trim()){h("Plate is required");return}const i=localStorage.getItem("token");if(!i){h("You must be logged in as manager to register vehicles.");return}T(!0);try{let r=g;if(u){const n=await fetch(`${o}/api/manager/vehicles/upload-base64`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({dataUrl:u})}),t=await n.json();if(!n.ok)throw new Error((t==null?void 0:t.error)||"Failed to upload image");r=t.image_url||r,N(r)}const B=await fetch(`${o}/api/manager/vehicles`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({plate:x.trim(),make:k||void 0,model:D||void 0,imageUrl:r||void 0})}),c=await B.json();if(!B.ok)throw new Error((c==null?void 0:c.error)||"Failed to register vehicle");const M=c.vehicle.id;if(d)if(m==="existing"){if(!p)throw new Error("Please select a driver to assign");const n=await fetch(`${o}/api/manager/drivers/${p}/vehicle`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({vehicleId:M})}),t=await n.json();if(!n.ok)throw new Error((t==null?void 0:t.error)||"Failed to assign vehicle to driver")}else{if(!f.trim()||!j.trim())throw new Error("Driver first and last name are required");const n=await fetch(`${o}/api/manager/drivers`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({firstName:f.trim(),lastName:j.trim()})}),t=await n.json();if(!n.ok)throw new Error((t==null?void 0:t.error)||"Failed to create driver");const z=(l=t==null?void 0:t.driver)==null?void 0:l.id;if(!z)throw new Error("Driver created but id missing");const L=await fetch(`${o}/api/manager/drivers/${z}/vehicle`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({vehicleId:M})}),y=await L.json();if(!L.ok)throw new Error((y==null?void 0:y.error)||"Failed to assign vehicle to new driver")}U(`Vehicle ${c.vehicle.plate} created${d?" and assigned":""}.`),S(""),C(""),$(""),A(!1),v("existing"),E(""),F(""),I(""),w(null),N("")}catch(r){h((r==null?void 0:r.message)||"Failed to register vehicle")}finally{T(!1)}}return e.jsxs("div",{className:"p-6 max-w-xl",children:[e.jsx("div",{className:"mb-2",children:e.jsx("button",{onClick:()=>R(-1),className:"text-blue-600 underline text-sm",children:"← Back"})}),e.jsx("h2",{className:"text-2xl font-bold mb-4",children:"Register Vehicle"}),O&&e.jsx("div",{className:"text-red-600 mb-2",children:O}),P&&e.jsx("div",{className:"text-green-600 mb-2",children:P}),e.jsxs("form",{onSubmit:q,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700",children:"Plate"}),e.jsx("input",{className:"mt-1 w-full border rounded px-3 py-2",value:x,onChange:s=>S(s.target.value),required:!0})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700",children:"Make"}),e.jsx("input",{className:"mt-1 w-full border rounded px-3 py-2",value:k,onChange:s=>C(s.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700",children:"Model"}),e.jsx("input",{className:"mt-1 w-full border rounded px-3 py-2",value:D,onChange:s=>$(s.target.value)})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700",children:"Vehicle Image (optional)"}),e.jsxs("div",{className:"mt-1 flex flex-col sm:flex-row items-start sm:items-center gap-3",children:[e.jsx("input",{type:"file",accept:"image/*",onChange:s=>{var r;const i=(r=s.target.files)==null?void 0:r[0];if(!i){w(null);return}const l=new FileReader;l.onload=()=>w(String(l.result||"")),l.readAsDataURL(i)},className:"block"}),e.jsx("input",{type:"url",placeholder:"Or paste image URL",value:g,onChange:s=>N(s.target.value),className:"w-full sm:w-72 border rounded px-3 py-2"})]}),(u||g)&&e.jsx("div",{className:"mt-3",children:e.jsx("img",{src:u||g,alt:"Vehicle preview",className:"max-h-40 rounded border"})})]}),e.jsx("div",{className:"pt-2",children:e.jsxs("label",{className:"inline-flex items-center",children:[e.jsx("input",{type:"checkbox",className:"mr-2",checked:d,onChange:s=>A(s.target.checked)}),e.jsx("span",{children:"Assign Driver (optional)"})]})}),d&&e.jsxs("div",{className:"p-4 border rounded",children:[e.jsxs("div",{className:"space-x-4 mb-3",children:[e.jsxs("label",{className:"inline-flex items-center",children:[e.jsx("input",{type:"radio",name:"assignMode",value:"existing",checked:m==="existing",onChange:()=>v("existing"),className:"mr-2"}),e.jsx("span",{children:"Assign to existing driver"})]}),e.jsxs("label",{className:"inline-flex items-center ml-4",children:[e.jsx("input",{type:"radio",name:"assignMode",value:"new",checked:m==="new",onChange:()=>v("new"),className:"mr-2"}),e.jsx("span",{children:"Create new driver"})]})]}),m==="existing"?e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700",children:"Select Driver"}),e.jsxs("select",{value:p,onChange:s=>E(s.target.value),className:"mt-1 w-full border rounded px-2 py-2",children:[e.jsx("option",{value:"",children:"-- Select driver --"}),V.map(s=>e.jsx("option",{value:s.id,children:s.username},s.id))]})]}):e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700",children:"Driver First Name"}),e.jsx("input",{className:"mt-1 w-full border rounded px-3 py-2",value:f,onChange:s=>F(s.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700",children:"Driver Last Name"}),e.jsx("input",{className:"mt-1 w-full border rounded px-3 py-2",value:j,onChange:s=>I(s.target.value)})]})]})]}),e.jsx("button",{type:"submit",disabled:b,className:`px-4 py-2 text-white rounded ${b?"bg-blue-400":"bg-blue-600 hover:bg-blue-700"}`,children:b?"Saving…":"Save Vehicle"})]})]})};export{G as default};
