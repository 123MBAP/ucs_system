import{u as H,j as e}from"./index-B34CxXhK.js";import{R as r}from"./react-BeLGUnOF.js";const o="http://localhost:4000";function V(){const{t:a,lang:L,setLang:B}=H(),[d,j]=r.useState(null),[N,y]=r.useState(""),[w,x]=r.useState([]),[D,h]=r.useState(!1),[S,m]=r.useState(null),[p,M]=r.useState(new Date().getFullYear()),[f,O]=r.useState(new Date().getMonth()+1),[T,_]=r.useState(!1),[P,k]=r.useState(null),[$,Z]=r.useState([]),[Y,J]=r.useState(null),[U,u]=r.useState(!1),[E,g]=r.useState(""),[c,C]=r.useState(!1),[z,A]=r.useState(null),[I,R]=r.useState(null);r.useEffect(()=>{let s=!0;return(async()=>{try{m(null);const t=localStorage.getItem("token");if(!t)throw new Error("Not authenticated");const n=await fetch(`${o}/api/chief/dashboard`,{headers:{Authorization:`Bearer ${t}`},credentials:"include"});if(!n.ok)throw new Error("Failed to load zone");const l=await n.json(),i=((l==null?void 0:l.zones)||[]).map(v=>({id:v.id,name:v.name}));if(!s)return;i.length?(j(i[0].id),y(i[0].name)):(j(null),y(""))}catch(t){if(!s)return;m((t==null?void 0:t.message)||"Failed to load")}})(),()=>{s=!1}},[]),r.useEffect(()=>{let s=!0;return(async()=>{if(!d){x([]);return}try{h(!0),m(null);const t=localStorage.getItem("token");if(!t)throw new Error("Not authenticated");const n=await fetch(`${o}/api/chief/zones/${d}/service-plan`,{headers:{Authorization:`Bearer ${t}`}});if(!n.ok)throw new Error("Failed to load schedule");const l=await n.json();if(!s)return;x((l==null?void 0:l.schedule)||[])}catch(t){if(!s)return;m((t==null?void 0:t.message)||"Failed to load schedule")}finally{s&&h(!1)}})(),()=>{s=!1}},[d]),r.useEffect(()=>{let s=!0;return(async()=>{try{k(null),_(!0);const t=localStorage.getItem("token");if(!t)throw new Error("Not authenticated");const n=new URLSearchParams({year:String(p),month:String(f)}),l=await fetch(`${o}/api/chief/completed-services?${n}`,{headers:{Authorization:`Bearer ${t}`},credentials:"include"});if(!l.ok)throw new Error("Failed to load completed services");const i=await l.json();if(!s)return;Z(Array.isArray(i==null?void 0:i.services)?i.services:[])}catch(t){if(!s)return;k((t==null?void 0:t.message)||"Failed to load")}finally{s&&_(!1)}})(),()=>{s=!1}},[p,f]);async function F(s,t,n){try{R(s);const l=localStorage.getItem("token");if(!l)throw new Error("Not authenticated");if(!(await fetch(`${o}/api/chief/service/${s}/report`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},credentials:"include",body:JSON.stringify({status:t,reason:n??null})})).ok)throw new Error("Failed to submit report");if(d){h(!0);try{const b=await(await fetch(`${o}/api/chief/zones/${d}/service-plan`,{headers:{Authorization:`Bearer ${l}`}})).json();x((b==null?void 0:b.schedule)||[])}finally{h(!1)}}}catch(l){console.error(l)}finally{R(null)}}function q(s){A(s),g(""),u(!0)}async function G(){if(z)try{C(!0),await F(z,"not_complete",E.trim()||null),u(!1),g(""),A(null)}finally{C(!1)}}return e.jsxs("div",{className:"space-y-6 lg:space-y-0 lg:grid lg:grid-cols-3 lg:gap-6",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-slate-800",children:a("chiefPlan.title")}),N&&e.jsxs("div",{className:"text-sm text-slate-600",children:[a("chiefPlan.zoneLabel")," ",e.jsx("span",{className:"font-medium text-slate-800",children:N})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-sm text-slate-600",children:a("common.language")}),e.jsxs("select",{value:L,onChange:s=>B(s.target.value),className:"rounded-md border border-slate-300 bg-white px-2 py-1 text-sm",children:[e.jsx("option",{value:"en",children:a("lang.english")}),e.jsx("option",{value:"rw",children:a("lang.kinyarwanda")})]})]})]}),S&&e.jsx("div",{className:"text-red-600 text-sm",children:S}),e.jsx("div",{className:"lg:col-span-2 space-y-4",children:D?e.jsx("div",{className:"rounded-lg border border-slate-200 bg-white p-6 text-center text-slate-500",children:a("chiefPlan.loading")}):w.length===0?e.jsx("div",{className:"rounded-lg border border-slate-200 bg-white p-6 text-center text-slate-500",children:a("chiefPlan.noEntries")}):e.jsx("div",{className:"space-y-4",children:w.filter(s=>!s.supervisor_status).map(s=>{var t,n;return e.jsxs("div",{className:"rounded-lg border border-slate-200 bg-white p-4",children:[e.jsxs("div",{className:"text-xs text-slate-500",children:[a("chiefPlan.createdAt")," ",new Date(s.created_at).toLocaleString()]}),e.jsxs("div",{className:"mt-2 space-y-1 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:a("chiefPlan.vehicle")})," ",s.vehicle_plate??a("chiefPlan.none")]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:a("chiefPlan.driver")})," ",s.driver_username?`${s.driver_username}${s.driver_phone?` (${s.driver_phone})`:""}`:a("chiefPlan.none")]})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"font-medium text-sm",children:a("chiefPlan.assignedManpowers")}),Array.isArray(s.assigned_manpower_users)&&s.assigned_manpower_users.length?e.jsx("ul",{className:"mt-1 list-disc pl-5 text-sm text-slate-700",children:s.assigned_manpower_users.map(l=>e.jsxs("li",{children:[l.username,l.phone?` (${l.phone})`:""]},l.id))}):e.jsx("div",{className:"mt-1 text-sm text-slate-500",children:a("chiefPlan.none")})]}),e.jsxs("div",{className:"mt-3 space-y-1 text-sm",children:[e.jsxs("div",{children:[a("chiefPlan.serviceStart")," ",(t=s.service_start)==null?void 0:t.slice(0,5)]}),e.jsxs("div",{children:[a("chiefPlan.serviceEnd")," ",(n=s.service_end)==null?void 0:n.slice(0,5)]})]}),s.chief_report_status?e.jsxs("div",{className:"mt-4 inline-flex items-center gap-2 rounded-md bg-amber-50 px-3 py-2 text-sm text-amber-800 border border-amber-200",children:[e.jsx("span",{className:"h-2 w-2 rounded-full bg-amber-500 inline-block"}),a("chiefPlan.report.waiting")]}):e.jsxs("div",{className:"mt-4 flex items-center gap-2",children:[e.jsx("button",{onClick:()=>F(s.id,"complete"),disabled:I===s.id,className:"inline-flex items-center rounded-md bg-emerald-600 px-3 py-1.5 text-white text-sm hover:bg-emerald-700 disabled:opacity-60",children:a("chiefPlan.report.complete")}),e.jsx("button",{onClick:()=>q(s.id),disabled:I===s.id,className:"inline-flex items-center rounded-md bg-red-600 px-3 py-1.5 text-white text-sm hover:bg-red-700 disabled:opacity-60",children:a("chiefPlan.report.notComplete")})]})]},s.id)})})}),e.jsx("div",{className:"lg:col-span-1",children:e.jsxs("div",{className:"rounded-lg border border-slate-200 bg-white p-4 lg:sticky lg:top-4",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsx("h3",{className:"text-base font-semibold text-slate-800",children:a("chiefPlan.completedServices")})}),e.jsxs("div",{className:"mt-3 grid grid-cols-2 gap-2",children:[e.jsx("select",{className:"w-full rounded-md border border-slate-300 bg-white px-2 py-1 text-sm",value:p,onChange:s=>M(Number(s.target.value)),children:Array.from({length:5}).map((s,t)=>{const n=new Date().getFullYear()-t;return e.jsx("option",{value:n,children:n},n)})}),e.jsx("select",{className:"w-full rounded-md border border-slate-300 bg-white px-2 py-1 text-sm",value:f,onChange:s=>O(Number(s.target.value)),children:Array.from({length:12}).map((s,t)=>{const n=t+1;return e.jsx("option",{value:n,children:n.toString().padStart(2,"0")},n)})})]}),P&&e.jsx("div",{className:"mt-2 text-xs text-red-600",children:P}),e.jsx("div",{className:"mt-3 space-y-2",children:T?e.jsx("div",{className:"text-sm text-slate-500",children:a("chiefPlan.completed.loading")}):$.length===0?e.jsx("div",{className:"text-sm text-slate-500",children:a("chiefPlan.completed.none")}):$.map(s=>e.jsxs("button",{onClick:()=>J(t=>t===s.id?null:s.id),className:"w-full text-left rounded-md border border-slate-200 px-3 py-2 hover:bg-slate-50",children:[e.jsxs("div",{className:"text-sm font-medium text-slate-800",children:[s.vehicle_plate??"—"," • ",s.driver_username??"—"]}),e.jsx("div",{className:"text-xs text-slate-500",children:new Date(s.supervisor_decided_at||s.created_at).toLocaleString()}),Y===s.id&&e.jsxs("div",{className:"mt-2 text-xs text-slate-700 space-y-2",children:[e.jsx("div",{children:a("chiefPlan.details.startEnd",{start:String(s.service_start).slice(0,5),end:String(s.service_end).slice(0,5)})}),e.jsxs("div",{children:[e.jsxs("span",{className:"font-semibold",children:[a("chiefPlan.vehicle")," "]}),e.jsx("span",{children:s.vehicle_plate??a("chiefPlan.none")})]}),e.jsxs("div",{children:[e.jsxs("span",{className:"font-semibold",children:[a("chiefPlan.driver")," "]}),e.jsx("span",{children:s.driver_username?`${s.driver_username}${s.driver_phone?` (${s.driver_phone})`:""}`:a("chiefPlan.none")})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold mb-0.5",children:a("chiefPlan.assignedManpowers")}),Array.isArray(s.assigned_manpower_users)&&s.assigned_manpower_users.length?e.jsx("ul",{className:"list-disc pl-5 space-y-0.5",children:s.assigned_manpower_users.map(t=>e.jsxs("li",{children:[t.username,t.phone?` (${t.phone})`:""]},t.id))}):e.jsx("div",{children:a("chiefPlan.none")})]}),s.supervisor_reason?e.jsx("div",{children:a("chiefPlan.details.supervisorNote",{note:s.supervisor_reason})}):null]})]},s.id))})]})}),U&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:()=>c?null:u(!1)}),e.jsxs("div",{className:"relative z-10 w-full max-w-md rounded-lg border border-slate-200 bg-white p-4 shadow-lg",children:[e.jsx("div",{className:"text-base font-semibold text-slate-800",children:a("chiefPlan.modal.title")}),e.jsx("div",{className:"mt-2 text-sm text-slate-600",children:a("chiefPlan.modal.subtitle")}),e.jsx("textarea",{value:E,onChange:s=>g(s.target.value),className:"mt-3 h-28 w-full resize-none rounded-md border border-slate-300 p-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-300",placeholder:a("chiefPlan.modal.placeholder"),disabled:c}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{onClick:()=>c?null:u(!1),className:"inline-flex items-center rounded-md border border-slate-300 px-3 py-1.5 text-sm text-slate-700 hover:bg-slate-50",disabled:c,children:a("chiefPlan.cancel")}),e.jsx("button",{onClick:G,className:"inline-flex items-center rounded-md bg-red-600 px-3 py-1.5 text-white text-sm hover:bg-red-700 disabled:opacity-60",disabled:c,children:a("chiefPlan.submit")})]})]})]})]})}export{V as default};
