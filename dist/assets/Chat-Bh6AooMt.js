import{u as F,j as e}from"./index-DMsqYpTw.js";import{R as c}from"./react-BeLGUnOF.js";function G(){const g="http://localhost:4000",{t:r}=F(),[i,S]=c.useState("general"),[w,$]=c.useState(""),[U,B]=c.useState([]),[u,y]=c.useState(null),[b,C]=c.useState(!1),[f,I]=c.useState(null),[m,A]=c.useState(()=>({general:0,workers:0}));let v=null,j=null;try{const t=localStorage.getItem("user"),s=t?JSON.parse(t):null;v=(s==null?void 0:s.role)??null,j=(s==null?void 0:s.id)??null}catch{}const N=v!=="client",z=v==="client";function d(){try{localStorage.removeItem("token"),localStorage.removeItem("user")}catch{}try{window.dispatchEvent(new Event("auth-changed"))}catch{}window.location.href="/login"}const E=c.useRef({}),D=t=>{const s=E.current[t];s&&(s.scrollIntoView({behavior:"smooth",block:"center"}),s.classList.add("ring-2","ring-gray-300","ring-opacity-50"),setTimeout(()=>s.classList.remove("ring-2","ring-gray-300","ring-opacity-50"),1e3))};async function _(t){try{C(!0),I(null);const s=localStorage.getItem("token");if(!s){d();return}const a=await fetch(`${g}/api/chat/messages?group=${encodeURIComponent(t)}&limit=100`,{headers:{Accept:"application/json",Authorization:s?`Bearer ${s}`:""}});if(a.status===401){d();return}if(!a.ok){const l=await a.json().catch(()=>({}));throw new Error((l==null?void 0:l.error)||`Failed to load messages (${a.status})`)}const n=await a.json(),o=Array.isArray(n==null?void 0:n.messages)?[...n.messages].reverse():[];B(o);try{const l=o.length?o[o.length-1].created_at:new Date().toISOString();localStorage.setItem(`chat_last_read_${t}`,l),window.dispatchEvent(new Event("chat-read"))}catch{}}catch(s){I(String((s==null?void 0:s.message)||s))}finally{C(!1)}}async function k(){try{const t=(()=>{var o;try{const l=localStorage.getItem("user");return l?((o=JSON.parse(l))==null?void 0:o.id)??null:null}catch{return null}})(),s=async o=>{const l=localStorage.getItem("token");if(!l)return d(),0;const p=await fetch(`${g}/api/chat/messages?group=${encodeURIComponent(o)}&limit=50`,{headers:{Accept:"application/json",Authorization:`Bearer ${l}`}});if(p.status===401)return d(),0;const h=await p.json().catch(()=>({})),L=Array.isArray(h==null?void 0:h.messages)?h.messages:[],R=localStorage.getItem(`chat_last_read_${o}`),O=R?new Date(R).getTime():0;let T=0;for(const x of L){const J=new Date((x==null?void 0:x.created_at)||0).getTime(),V=t!=null&&Number(x==null?void 0:x.user_id)===Number(t);J>O&&!V&&T++}return T},a=await s("general"),n=N?await s("workers"):0;A({general:a,workers:n})}catch{A(t=>t)}}c.useEffect(()=>{(async()=>(await _(i),await k()))()},[i]),c.useEffect(()=>{k()},[]),c.useEffect(()=>{const t=localStorage.getItem("token");if(!t){d();return}const s=`${g}/api/chat/stream?token=${encodeURIComponent(t)}`;let a=null;try{a=new EventSource(s),a.onmessage=async()=>{await _(i),await k()},a.onerror=()=>{}}catch{}return()=>{try{a&&a.close()}catch{}}},[g,i,N]);async function H(){const t=w.trim();if(t)try{const s=localStorage.getItem("token");if(!s){d();return}const a=await fetch(`${g}/api/chat/messages`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:s?`Bearer ${s}`:""},body:JSON.stringify({group:i,message:t,reply_to_id:(u==null?void 0:u.id)??null})});if(a.status===401){d();return}if(!a.ok){const n=await a.json().catch(()=>({}));throw new Error((n==null?void 0:n.error)||`Failed to send message (${a.status})`)}$(""),y(null),await _(i)}catch(s){alert(String((s==null?void 0:s.message)||s))}}const M=U.filter(t=>t.group===i);return e.jsx("div",{className:"p-3 sm:p-4 md:p-6 bg-gradient-to-br from-gray-50 to-white min-h-screen",children:e.jsxs("div",{className:"max-w-5xl w-full mx-auto bg-white rounded-xl sm:rounded-2xl shadow-md border border-neutral-200 overflow-hidden",children:[e.jsx("div",{className:"px-4 sm:px-6 py-3 sm:py-4 border-b border-neutral-200 bg-white text-neutral-900",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg sm:text-xl font-bold",children:r("chat.title")}),e.jsx("div",{className:"text-xs sm:text-sm text-neutral-600 mt-1",children:r(i==="general"?"chat.subtitleGeneral":"chat.subtitleWorkers")})]}),!z&&e.jsx("div",{className:"bg-neutral-100 border border-neutral-200 rounded-lg p-1",children:e.jsxs("div",{className:"flex text-xs sm:text-sm font-medium",children:[e.jsx("button",{className:`${i==="general"?"bg-neutral-800 text-white shadow-sm":"text-neutral-700 hover:text-neutral-900"} px-3 sm:px-4 py-1.5 sm:py-2 rounded-md transition-all duration-200`,onClick:()=>S("general"),children:e.jsxs("span",{className:"inline-flex items-center gap-2",children:[r("chat.tab.allUsers"),m.general>0&&e.jsx("span",{className:"text-[10px] bg-red-500 text-white rounded-full px-1.5 py-0.5",children:m.general>99?"99+":m.general})]})}),N&&e.jsx("button",{className:`${i==="workers"?"bg-neutral-800 text-white shadow-sm":"text-neutral-700 hover:text-neutral-900"} px-3 sm:px-4 py-1.5 sm:py-2 rounded-md transition-all duration-200`,onClick:()=>S("workers"),children:e.jsxs("span",{className:"inline-flex items-center gap-2",children:[r("chat.tab.workers"),m.workers>0&&e.jsx("span",{className:"text-[10px] bg-red-500 text-white rounded-full px-1.5 py-0.5",children:m.workers>99?"99+":m.workers})]})})]})})]})}),e.jsxs("div",{className:"flex flex-col h-[64vh] sm:h-[66vh] md:h-[70vh]",children:[e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 sm:p-6 space-y-4 bg-white",children:[b&&e.jsx("div",{className:"flex justify-center",children:e.jsx("div",{className:"animate-pulse text-gray-500 text-sm",children:r("chat.loading")})}),f&&e.jsx("div",{className:"text-center text-red-600 text-sm bg-red-50 py-2 rounded-lg border border-red-200",children:f}),!b&&!f&&M.length===0&&e.jsxs("div",{className:"text-center text-gray-500 py-8",children:[e.jsx("div",{className:"text-lg font-medium mb-2",children:r("chat.noMessagesTitle")}),e.jsx("div",{className:"text-sm",children:r("chat.noMessagesDesc")})]}),!b&&!f&&M.map(t=>{const s=j!=null&&t.user_id===j,a=s?r("chat.you"):t.client_name&&(t.client_name.first||t.client_name.last)?`${t.client_name.first??""} ${t.client_name.last??""}`.trim():t.client_username||t.user_username||r("chat.user"),n=t.client_avatar||"",o=(t.message||"").slice(0,80),l=t.reply_client_name&&(t.reply_client_name.first||t.reply_client_name.last)?`${t.reply_client_name.first??""} ${t.reply_client_name.last??""}`.trim():t.reply_client_username||t.reply_user_username||null,p=t.reply_message;return e.jsx("div",{className:`flex ${s?"justify-end":"justify-start"} group`,ref:h=>{E.current[t.id]=h},children:e.jsxs("div",{className:`flex gap-3 max-w-[85%] ${s?"flex-row-reverse":""}`,children:[e.jsx("div",{className:`flex flex-col items-center ${s?"order-2":""}`,children:e.jsx("div",{className:"w-10 h-10 rounded-full overflow-hidden ring-2 ring-white shadow-sm bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center text-sm font-semibold text-gray-700",children:n?e.jsx("img",{src:n,alt:a,className:"w-full h-full object-cover"}):((a==null?void 0:a[0])||"U").toUpperCase()})}),e.jsxs("div",{className:`flex-1 ${s?"text-right":""}`,children:[e.jsxs("div",{className:`flex items-center gap-2 mb-1 ${s?"justify-end":"justify-start"}`,children:[e.jsx("span",{className:"text-sm font-semibold text-slate-700",children:a}),e.jsx("span",{className:"text-xs text-slate-500",children:new Date(t.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]}),e.jsxs("div",{className:"relative",children:[p&&e.jsx("div",{className:`mb-2 rounded-lg border-l-4 cursor-pointer transition-all hover:shadow-sm ${s?"border-l-neutral-400 bg-neutral-50 text-neutral-800":"border-l-gray-300 bg-gray-50 text-neutral-800"}`,onClick:()=>t.reply_id&&D(t.reply_id),children:e.jsxs("div",{className:"p-2",children:[e.jsx("div",{className:"text-xs font-semibold mb-1",children:r("chat.replyingTo",{name:l||r("chat.user")})}),e.jsx("div",{className:"text-xs text-gray-600 line-clamp-2",children:p})]})}),e.jsxs("div",{className:`relative inline-block max-w-full px-4 py-3 rounded-2xl shadow-sm transition-all ${s?"bg-neutral-800 text-white rounded-br-md":"bg-white text-neutral-800 border border-neutral-200 rounded-bl-md hover:border-neutral-300"}`,children:[e.jsx("button",{title:r("chat.replyButtonTitle"),onClick:()=>y({id:t.id,name:a,snippet:o}),className:`absolute top-1/2 transform -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-all duration-200 ${s?"-left-12 bg-white text-neutral-800 hover:bg-gray-50":"-right-12 bg-gray-100 text-gray-600 hover:bg-gray-200"} w-8 h-8 rounded-full flex items-center justify-center shadow-md border`,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",className:"w-4 h-4",children:e.jsx("path",{d:"M10 8.5V6l-6 6 6 6v-2.5l4-.5a6 6 0 004.5-3.5l.5-1-1 .2A17 17 0 0010 8.5z"})})}),e.jsx("div",{className:"text-sm leading-relaxed whitespace-pre-wrap break-words",children:t.message})]})]})]})]})},t.id)})]}),e.jsxs("div",{className:"border-t border-neutral-200 bg-white/95 backdrop-blur-sm p-4 space-y-3",children:[u&&e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg border border-neutral-200 bg-neutral-50",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"text-sm font-semibold text-neutral-800 flex items-center gap-2",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",className:"w-4 h-4",children:e.jsx("path",{d:"M10 8.5V6l-6 6 6 6v-2.5l4-.5a6 6 0 004.5-3.5l.5-1-1 .2A17 17 0 0010 8.5z"})}),r("chat.replyingTo",{name:u.name})]}),e.jsx("div",{className:"text-sm text-gray-700 mt-1 line-clamp-2",children:u.snippet})]}),e.jsx("button",{onClick:()=>y(null),className:"text-neutral-700 hover:text-neutral-900 text-sm font-medium px-3 py-1 rounded-md hover:bg-gray-100 transition-colors",children:r("chat.cancel")})]}),e.jsxs("div",{className:"flex items-end gap-3",children:[e.jsx("div",{className:"flex-1",children:e.jsx("textarea",{value:w,onChange:t=>$(t.target.value),className:"w-full px-4 py-3 rounded-xl border border-neutral-300 focus:outline-none focus:ring-2 focus:ring-neutral-700 focus:border-transparent bg-white text-neutral-900 placeholder-gray-500 resize-none",placeholder:r(i==="general"?"chat.placeholder.general":"chat.placeholder.workers"),rows:1,style:{minHeight:"44px",maxHeight:"120px"},onInput:t=>{const s=t.target;s.style.height="auto",s.style.height=Math.min(s.scrollHeight,120)+"px"}})}),e.jsxs("button",{onClick:H,disabled:!w.trim(),className:"px-6 py-3 rounded-xl bg-neutral-900 text-white font-medium hover:bg-neutral-800 shadow-sm transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",className:"w-4 h-4",children:e.jsx("path",{d:"M3.478 2.404a.75.75 0 00-.926.941l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.404z"})}),r("chat.send")]})]})]})]})]})})}export{G as default};
